"use strict";import H from"../Core/Globals.js";const{pageLang,win}=H;import U from"../Core/Utilities.js";const{defined,error,extend,isNumber,isObject,isString,merge,objectEach,pad,splat,timeUnits,ucfirst}=U,hasOldSafariBug=H.isSafari&&win.Intl&&!win.Intl.DateTimeFormat.prototype.formatRange,isDateTimeFormatOptions=e=>void 0===e.main;class TimeBase{constructor(e,t){this.options={timezone:"UTC"},this.variableTimezone=!1,this.Date=win.Date,this.update(e),this.lang=t}update(e={}){this.dTLCache={},this.options=e=merge(!0,this.options,e);var{timezoneOffset:t,useUTC:i,locale:s}=e;this.Date=e.Date||win.Date||Date;let r=e.timezone;defined(i)&&(r=i?"UTC":void 0),t&&t%60==0&&(r="Etc/GMT"+(0<t?"+":"")+t/60),this.variableTimezone="UTC"!==r&&0!==r?.indexOf("Etc/GMT"),this.timezone=r,this.lang&&s&&(this.lang.locale=s),["months","shortMonths","weekdays","shortWeekdays"].forEach(e=>{const t=/months/i.test(e),i=/short/.test(e),s={timeZone:"UTC"};s[t?"month":"weekday"]=i?"short":"long",this[e]=(t?[0,1,2,3,4,5,6,7,8,9,10,11]:[3,4,5,6,7,8,9]).map(e=>this.dateFormat(s,24*(t?31:1)*36e5*e))})}toParts(e){const[t,i,s,r,a,o,n]=this.dateTimeFormat({weekday:"narrow",day:"numeric",month:"numeric",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric"},e,"es").split(/(?:, | |\/|:)/g);return[r,+s-1,i,a,o,n,Math.floor(Number(e)||0)%1e3,"DLMXJVS".indexOf(t)].map(Number)}dateTimeFormat(t,e,i=this.options.locale||pageLang){var s=JSON.stringify(t)+i;isString(t)&&(t=this.str2dtf(t));let r=this.dTLCache[s];if(!r){t.timeZone??(t.timeZone=this.timezone);try{r=new Intl.DateTimeFormat(i,t)}catch(e){/Invalid time zone/i.test(e.message)?(error(34),t.timeZone="UTC",r=new Intl.DateTimeFormat(i,t)):error(e.message,!1)}}return(this.dTLCache[s]=r)?.format(e)||""}str2dtf(t,i={}){const s={L:{fractionalSecondDigits:3},S:{second:"2-digit"},M:{minute:"numeric"},H:{hour:"2-digit"},k:{hour:"numeric"},E:{weekday:"narrow"},a:{weekday:"short"},A:{weekday:"long"},d:{day:"2-digit"},e:{day:"numeric"},b:{month:"short"},B:{month:"long"},m:{month:"2-digit"},o:{month:"numeric"},y:{year:"2-digit"},Y:{year:"numeric"}};return Object.keys(s).forEach(e=>{-1!==t.indexOf(e)&&extend(i,s[e])}),i}makeTime(e,t,i=1,s=0,r,a,o){let n=this.Date.UTC(e,t,i,s,r||0,a||0,o||0);return"UTC"!==this.timezone&&(e=this.getTimezoneOffset(n),n+=e,-1!==[2,3,8,9,10,11].indexOf(t)&&(s<5||20<s)&&(e!==(i=this.getTimezoneOffset(n))?n+=i-e:e-36e5!==this.getTimezoneOffset(n-36e5)||hasOldSafariBug||(n-=36e5))),n}parse(e){if(!isString(e))return e??void 0;var t=-1<(e=e.replace(/\//g,"-").replace(/(GMT|UTC)/,"")).indexOf("Z")||/([+-][0-9]{2}):?[0-9]{2}$/.test(e),i=/^[0-9]{4}-[0-9]{2}(-[0-9]{2}|)$/.test(e),e=(t||i||(e+="Z"),Date.parse(e));return isNumber(e)?e+(!t||i?this.getTimezoneOffset(e):0):void 0}getTimezoneOffset(e){if("UTC"!==this.timezone){var[,,e,,t=0]=this.dateTimeFormat({timeZoneName:"shortOffset"},e,"en").split(/(GMT|:)/).map(Number),e=60*-(e+t/60)*6e4;if(isNumber(e))return e}return 0}dateFormat(i,s,e){var t,r,a,o,n=this.lang;if(!defined(s)||isNaN(s))return n?.invalidDate||"";if(i=i??"%Y-%m-%d %H:%M:%S",isString(i)){const m=/%\[([a-zA-Z]+)\]/g;for(;t=m.exec(i);)i=i.replace(t[0],this.dateTimeFormat(t[1],s,n?.locale))}if(isString(i)&&-1!==i.indexOf("%")){const d=this,[h,f,c,u,l,g,p,T]=this.toParts(s),b=n?.weekdays||this.weekdays,y=n?.shortWeekdays||this.shortWeekdays,O=n?.months||this.months,w=n?.shortMonths||this.shortMonths,k=extend({a:y?y[T]:b[T].substr(0,3),A:b[T],d:pad(c),e:pad(c,2," "),w:T,v:n?.weekFrom??"",b:w[f],B:O[f],m:pad(f+1),o:f+1,y:h.toString().substr(2,2),Y:h,H:pad(u),k:u,I:pad(u%12||12),l:u%12||12,M:pad(l),p:u<12?"AM":"PM",P:u<12?"am":"pm",S:pad(g),L:pad(p,3)},H.dateFormats);objectEach(k,function(e,t){if(isString(i))for(;-1!==i.indexOf("%"+t);)i=i.replace("%"+t,"function"==typeof e?e.call(d,s):e)})}else isObject(i)&&(r=(this.getTimezoneOffset(s)||0)/36e5,r=this.timezone||"Etc/GMT"+(0<=r?"+":"")+r,{prefix:a="",suffix:o=""}=i,i=a+this.dateTimeFormat(extend({timeZone:r},i),s)+o);return e?ucfirst(i):i}resolveDTLFormat(e){return isObject(e,!0)?isObject(e,!0)&&isDateTimeFormatOptions(e)?{main:e}:e:{main:(e=splat(e))[0],from:e[1],to:e[2]}}getDateFormat(e,t,i,s){const r=this.dateFormat("%m-%d %H:%M:%S.%L",t),a="01-01 00:00:00.000",o={millisecond:15,second:12,minute:9,hour:6,day:3};let n="millisecond",m=n;for(n in timeUnits){if(e&&e===timeUnits.week&&+this.dateFormat("%w",t)===i&&r.substr(6)===a.substr(6)){n="week";break}if(e&&timeUnits[n]>e){n=m;break}if(o[n]&&r.substr(o[n])!==a.substr(o[n]))break;"week"!==n&&(m=n)}return this.resolveDTLFormat(s[n]).main}}export default TimeBase;
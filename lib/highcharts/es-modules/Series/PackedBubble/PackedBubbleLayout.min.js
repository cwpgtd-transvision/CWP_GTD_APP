"use strict";import GraphLayout from"../GraphLayoutComposition.js";import PackedBubbleIntegration from"./PackedBubbleIntegration.js";import ReingoldFruchtermanLayout from"../Networkgraph/ReingoldFruchtermanLayout.js";import U from"../../Core/Utilities.js";const{addEvent,defined,pick}=U;function chartGetSelectedParentNodes(){const e=this.series,t=[];return e.forEach(e=>{e.parentNode&&e.parentNode.selected&&t.push(e.parentNode)}),t}function onChartBeforeRedraw(){this.allDataPoints&&delete this.allDataPoints}class PackedBubbleLayout extends ReingoldFruchtermanLayout{constructor(){super(...arguments),this.index=NaN,this.nodes=[],this.series=[]}static compose(e){ReingoldFruchtermanLayout.compose(e),GraphLayout.integrations.packedbubble=PackedBubbleIntegration,GraphLayout.layouts.packedbubble=PackedBubbleLayout;const t=e.prototype;t.getSelectedParentNodes||(addEvent(e,"beforeRedraw",onChartBeforeRedraw),t.getSelectedParentNodes=chartGetSelectedParentNodes),t.allParentNodes||(t.allParentNodes=[])}beforeStep(){this.options.marker&&this.series.forEach(e=>{e&&e.calculateParentRadius()})}isStable(){var e=Math.abs(this.prevSystemTemperature-this.systemTemperature),t=10*this.systemTemperature/Math.sqrt(this.nodes.length);return Math.abs(t)<1&&e<1e-5||this.temperature<=0}setCircularPositions(){var e=this,t=e.box,r=[...e.nodes,...e?.chart?.allParentNodes||[]],s=2*Math.PI/(r.length+1),o=e.options.initialPositionRadius;let a,i,n=0;for(const d of r)i=this.resolveSplitSeries(d)&&!d.isParentNode?(a=d.series.parentNode.plotX,d.series.parentNode.plotY):(a=t.width/2,t.height/2),d.plotX=d.prevX=pick(d.plotX,a+o*Math.cos(d.index||n*s)),d.plotY=d.prevY=pick(d.plotY,i+o*Math.sin(d.index||n*s)),d.dispX=0,d.dispY=0,n++}repulsiveForces(){var t=this,{options:e,k:r}=t,{bubblePadding:s=0,seriesInteraction:o}=e,a=[...t.nodes,...t?.chart?.allParentNodes||[]];for(const u of a){var i=u.series,n=u.fixedPosition,d=(u.marker?.radius||0)+s;u.degree=u.mass,u.neighbours=0;for(const h of a){var l=h.series;if(u!==h&&!n&&(o||i===l)&&(i!==l||!h.isParentNode&&!u.isParentNode)){var l=t.getDistXY(u,h),p=t.vectorLength(l)-(d+(h.marker?.radius||0));let e;p<0&&(u.degree+=.01,e=t.repulsiveForce(-p/Math.sqrt(++u.neighbours),r,u,h)*h.mass),t.force("repulsive",u,e||0,l,h,p)}}}}resolveSplitSeries(e){var t=e.series?.options?.layoutAlgorithm?.splitSeries;return!defined(t)&&e.series.chart?.options?.plotOptions?.packedbubble?.layoutAlgorithm?.splitSeries||t||!1}applyLimitBox(e,t){var r,s=this;this.resolveSplitSeries(e)&&!e.isParentNode&&s.options.parentNodeLimit&&(r=s.getDistXY(e,e.series.parentNode),(s=e.series.parentNodeRadius-e.marker.radius-s.vectorLength(r))<0&&s>-2*e.marker.radius&&(e.plotX-=.01*r.x,e.plotY-=.01*r.y)),super.applyLimitBox(e,t)}}export default GraphLayout.layouts.packedbubble=PackedBubbleLayout;
"use strict";import BubbleLegendDefaults from"./BubbleLegendDefaults.js";import BubbleLegendItem from"./BubbleLegendItem.js";import D from"../../Core/Defaults.js";const setOptions=D["setOptions"];import H from"../../Core/Globals.js";const composed=H["composed"];import U from"../../Core/Utilities.js";const{addEvent,objectEach,pushUnique,wrap}=U;function chartDrawChartBox(e,t,n){const s=this,l=s.legend,o=0<=getVisibleBubbleSeriesIndex(s);let i,b,r;l&&l.options.enabled&&l.bubbleLegend&&l.options.bubbleLegend.autoRanges&&o?(i=l.bubbleLegend.options,b=l.bubbleLegend.predictBubbleSizes(),l.bubbleLegend.updateRanges(b[0],b[1]),i.placed||(l.group.placed=!1,l.allItems.forEach(e=>{(r=e.legendItem||{}).group&&(r.group.translateY=void 0)})),l.render(),i.placed||(s.getMargins(),s.axes.forEach(e=>{e.setScale(),e.updateNames(),objectEach(e.ticks,function(e){e.isNew=!0,e.isNewLabel=!0})}),s.getMargins()),i.placed=!0,e.call(s,t,n),l.bubbleLegend.correctSizes(),retranslateItems(l,getLinesHeights(l))):(e.call(s,t,n),l&&l.options.enabled&&l.bubbleLegend&&(l.render(),retranslateItems(l,getLinesHeights(l))))}function compose(e,t){pushUnique(composed,"Series.BubbleLegend")&&(setOptions({legend:{bubbleLegend:BubbleLegendDefaults}}),wrap(e.prototype,"drawChartBox",chartDrawChartBox),addEvent(t,"afterGetAllItems",onLegendAfterGetAllItems),addEvent(t,"itemClick",onLegendItemClick))}function getVisibleBubbleSeriesIndex(e){var t=e.series;let n=0;for(;n<t.length;){if(t[n]&&t[n].isBubble&&t[n].visible&&t[n].dataTable.rowCount)return n;n++}return-1}function getLinesHeights(e){const t=e.allItems,n=[],s=t.length;let l,o,i,b=0,r=0;for(b=0;b<s;b++)if(o=t[b].legendItem||{},i=(t[b+1]||{}).legendItem||{},o.labelHeight&&(t[b].itemHeight=o.labelHeight),t[b]===t[s-1]||o.y!==i.y){for(n.push({height:0}),l=n[n.length-1],r;r<=b;r++)t[r].itemHeight>l.height&&(l.height=t[r].itemHeight);l.step=b}return n}function onLegendAfterGetAllItems(e){const t=this,n=t.bubbleLegend,s=t.options,l=s.bubbleLegend,o=getVisibleBubbleSeriesIndex(t.chart);n&&n.ranges&&n.ranges.length&&(l.ranges.length&&(l.autoRanges=!!l.ranges[0].autoRanges),t.destroyItem(n)),0<=o&&s.enabled&&l.enabled&&(l.seriesIndex=o,t.bubbleLegend=new BubbleLegendItem(l,t),t.bubbleLegend.addToLegend(e.allItems))}function onLegendItemClick(e){if(e.defaultPrevented)return!1;const t=this,n=e.legendItem,s=t.chart,l=n.visible;t&&t.bubbleLegend&&(n.visible=!l,n.ignoreSeries=l,e=0<=getVisibleBubbleSeriesIndex(s),t.bubbleLegend.visible!==e&&(t.update({bubbleLegend:{enabled:e}}),t.bubbleLegend.visible=e),n.visible=l)}function retranslateItems(e,n){const t=e.allItems,s=e.options.rtl;let l,o,i,b,r=0;t.forEach((e,t)=>{(b=e.legendItem||{}).group&&(l=b.group.translateX||0,o=b.y||0,((i=e.movementX)||s&&e.ranges)&&(i=s?l-e.options.maxSize/2:l+i,b.group.attr({translateX:i})),t>n[r].step&&r++,b.group.attr({translateY:Math.round(o+n[r].height/2)}),b.y=o+n[r].height/2)})}const BubbleLegendComposition={compose:compose};export default BubbleLegendComposition;
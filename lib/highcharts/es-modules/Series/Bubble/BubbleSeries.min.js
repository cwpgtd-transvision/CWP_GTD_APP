"use strict";import BubbleLegendComposition from"./BubbleLegendComposition.js";import BubblePoint from"./BubblePoint.js";import H from"../../Core/Globals.js";const{composed,noop}=H;import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const{series:Series,seriesTypes:{column:{prototype:columnProto},scatter:ScatterSeries}}=SeriesRegistry;import U from"../../Core/Utilities.js";const{addEvent,arrayMax,arrayMin,clamp,extend,isNumber,merge,pick,pushUnique}=U;function onAxisFoundExtremes(){const e=this.len,{coll:t,isXAxis:s,min:a}=this,o=(this.max||0)-(a||0);let n=0,l=e,h=e/o,u;"xAxis"!==t&&"yAxis"!==t||(this.series.forEach(t=>{if(t.bubblePadding&&t.reserveSpace()){this.allowZoomOutside=!0,u=!0;var i,r=t.getColumn(s?"x":"y");if(s&&((t.onPoint||t).getRadii(0,0,t),t.onPoint&&(t.radii=t.onPoint.radii)),0<o){let e=r.length;for(;e--;)isNumber(r[e])&&this.dataMin<=r[e]&&r[e]<=this.max&&(i=t.radii&&t.radii[e]||0,n=Math.min((r[e]-a)*h-i,n),l=Math.max((r[e]-a)*h+i,l))}}}),u&&0<o&&!this.logarithmic&&(l-=e,h*=(e+Math.max(0,n)-Math.min(l,e))/e,[["min","userMin",n],["max","userMax",l]].forEach(e=>{void 0===pick(this.options[e[0]],this[e[1]])&&(this[e[0]]+=e[2]/h)})))}function onAxisAfterRender(){var{ticks:t,tickPositions:i,dataMin:r=0,dataMax:s=0,categories:e}=this,a=this.options.type;if((e?.length||"category"===a)&&this.series.find(e=>e.bubblePadding)){let e=i.length;for(;e--;){const o=t[i[e]],n=o.pos||0;(s<n||n<r)&&o.label?.hide()}}}class BubbleSeries extends ScatterSeries{static compose(e,t,i){BubbleLegendComposition.compose(t,i),pushUnique(composed,"Series.Bubble")&&(addEvent(e,"foundExtremes",onAxisFoundExtremes),addEvent(e,"afterRender",onAxisAfterRender))}animate(e){!e&&this.points.length<this.options.animationLimit&&this.points.forEach(function(e){const{graphic:t,plotX:i=0,plotY:r=0}=e;t&&t.width&&(this.hasRendered||t.attr({x:i,y:r,width:1,height:1}),t.animate(this.markerAttribs(e),this.options.animation))},this)}getRadii(){const e=this.getColumn("z"),t=this.getColumn("y"),i=[];let r,s,a,o=this.chart.bubbleZExtremes;var{minPxSize:n,maxPxSize:l}=this.getPxExtremes();if(!o){let t=Number.MAX_VALUE,i=-Number.MAX_VALUE,r;this.chart.series.forEach(e=>{e.bubblePadding&&e.reserveSpace()&&((e=(e.onPoint||e).getZExtremes())&&(t=Math.min(pick(t,e.zMin),e.zMin),i=Math.max(pick(i,e.zMax),e.zMax),r=!0))}),r?(o={zMin:t,zMax:i},this.chart.bubbleZExtremes=o):o={zMin:0,zMax:0}}for(s=0,r=e.length;s<r;s++)a=e[s],i.push(this.getRadius(o.zMin,o.zMax,n,l,a,t&&t[s]));this.radii=i}getRadius(e,t,i,r,s,a){var o=this.options,n="width"!==o.sizeBy,l=o.zThreshold;let h=t-e,u=.5;if(null===a||null===s)return null;if(isNumber(s)){if(o.sizeByAbsoluteValue&&(s=Math.abs(s-l),t=h=Math.max(t-l,Math.abs(e-l)),e=0),s<e)return i/2-1;0<h&&(u=(s-e)/h)}return n&&0<=u&&(u=Math.sqrt(u)),Math.ceil(i+u*(r-i))/2}hasData(){return!!this.dataTable.rowCount}markerAttribs(e,t){var t=super.markerAttribs(e,t),{height:i=0,width:r=0}=t;return this.chart.inverted?extend(t,{x:(e.plotX||0)-r/2,y:(e.plotY||0)-i/2}):t}pointAttribs(e,t){const i=this.options.marker,r=i?.fillOpacity,s=Series.prototype.pointAttribs.call(this,e,t);return s["fill-opacity"]=r??1,s}translate(){super.translate.call(this),this.getRadii(),this.translateBubble()}translateBubble(){var{data:e,options:t,radii:i}=this,r=this.getPxExtremes()["minPxSize"];let s=e.length;for(;s--;){const a=e[s],o=i?i[s]:0;"z"===this.zoneAxis&&(a.negative=(a.z||0)<(t.zThreshold||0)),isNumber(o)&&r/2<=o?(a.marker=extend(a.marker,{radius:o,width:2*o,height:2*o}),a.dlBox={x:a.plotX-o,y:a.plotY-o,width:2*o,height:2*o}):(a.shapeArgs=a.plotY=a.dlBox=void 0,a.isInside=!1)}}getPxExtremes(){const i=Math.min(this.chart.plotWidth,this.chart.plotHeight);var e=e=>{let t;return"string"==typeof e&&(t=/%$/.test(e),e=parseInt(e,10)),t?i*e/100:e},t=e(pick(this.options.minSize,8));return{minPxSize:t,maxPxSize:Math.max(e(pick(this.options.maxSize,"20%")),t)}}getZExtremes(){var e=this.options,t=this.getColumn("z").filter(isNumber);if(t.length){var i=pick(e.zMin,clamp(arrayMin(t),!1===e.displayNegative?e.zThreshold||0:-Number.MAX_VALUE,Number.MAX_VALUE)),e=pick(e.zMax,arrayMax(t));if(isNumber(i)&&isNumber(e))return{zMin:i,zMax:e}}}searchKDTree(e,t,i,r=noop,s=noop){return super.searchKDTree(e,t,i,(e,t,i)=>{var r=e[i]||0,i=t[i]||0;let s,a=!1;return r===i?s=e.index>t.index?e:t:r<0&&i<0?(s=r-(e.marker?.radius||0)>=i-(t.marker?.radius||0)?e:t,a=!0):s=r<i?e:t,[s,a]},(e,t,i)=>!i&&t<e||e<t)}}BubbleSeries.defaultOptions=merge(ScatterSeries.defaultOptions,{dataLabels:{formatter:function(){const e=this.series.chart["numberFormatter"];var t=this.point["z"];return isNumber(t)?e(t,-1):""},inside:!0,verticalAlign:"middle"},animationLimit:250,marker:{lineColor:null,lineWidth:1,fillOpacity:.5,radius:null,states:{hover:{radiusPlus:0}},symbol:"circle"},minSize:8,maxSize:"20%",softThreshold:!1,states:{hover:{halo:{size:5}}},tooltip:{pointFormat:"({point.x}, {point.y}), Size: {point.z}"},turboThreshold:0,zThreshold:0,zoneAxis:"z"}),extend(BubbleSeries.prototype,{alignDataLabel:columnProto.alignDataLabel,applyZones:noop,bubblePadding:!0,isBubble:!0,keysAffectYAxis:["y"],pointArrayMap:["y","z"],pointClass:BubblePoint,parallelArrays:["x","y","z"],trackerGroups:["group","dataLabelsGroup"],specialGroup:"group",zoneAxis:"z"}),addEvent(BubbleSeries,"updatedData",e=>{delete e.target.chart.bubbleZExtremes}),addEvent(BubbleSeries,"remove",e=>{delete e.target.chart.bubbleZExtremes}),SeriesRegistry.registerSeriesType("bubble",BubbleSeries);export default BubbleSeries;
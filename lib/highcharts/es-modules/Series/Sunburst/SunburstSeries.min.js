"use strict";import CU from"../CenteredUtilities.js";const{getCenter,getStartAndEndRadians}=CU;import H from"../../Core/Globals.js";const noop=H["noop"];import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const{column:ColumnSeries,treemap:TreemapSeries}=SeriesRegistry.seriesTypes;import SunburstPoint from"./SunburstPoint.js";import SunburstUtilities from"./SunburstUtilities.js";import TU from"../TreeUtilities.js";const{getColor,getLevelOptions,setTreeValues,updateRootId}=TU;import U from"../../Core/Utilities.js";import SunburstNode from"./SunburstNode.js";import SunburstSeriesDefaults from"./SunburstSeriesDefaults.js";const{defined,error,extend,fireEvent,isNumber,isObject,isString,merge,splat}=U;import SVGElement from"../../Core/Renderer/SVG/SVGElement.js";import TextPath from"../../Extensions/TextPath.js";TextPath.compose(SVGElement);const rad2deg=180/Math.PI;function isBoolean(e){return"boolean"==typeof e}const getEndPoint=function(e,t,r,s){return{x:e+Math.cos(r)*s,y:t+Math.sin(r)*s}};function getDlOptions(e){const t=e.point,r=isObject(e.shapeArgs)?e.shapeArgs:{},{end:s=0,radius:o=0,start:i=0}=r,n=isObject(e.optionsPoint)?e.optionsPoint.dataLabels:{},a=splat(isObject(e.level)?e.level.dataLabels:{})[0],l=merge(a,n),d=l.style=l.style||{},{innerArcLength:p=0,outerArcLength:u=0}=t;let c,h,g=l.rotationMode,b=defined(d.width)?parseInt(d.width||"0",10):void 0;return isNumber(l.rotation)||("auto"!==g&&"circular"!==g||(l.useHTML&&"circular"===g&&(g="auto"),p<1&&o<u?(c=0,t.dataLabelPath&&"circular"===g&&(l.textPath={enabled:!0}),s-i<Math.PI&&(b=.7*o)):1<p&&1.5*o<u?"circular"===g?l.textPath={enabled:!0,attributes:{dy:5}}:g="parallel":(t.dataLabel?.textPath&&"circular"===g&&(l.textPath={enabled:!1}),g="perpendicular")),"auto"!==g&&"circular"!==g&&(t.dataLabel?.textPath&&(l.textPath={enabled:!1}),c=s-(s-i)/2),"parallel"===g?b=Math.min(2.5*o,(u+p)/2):!defined(b)&&o&&(b=1===t.node.level?2*o:o),"perpendicular"===g&&(u<16?b=1:r.radius&&(d.lineClamp=Math.floor(p/16)||1,b=o-(p<16?o*((16-p)/(u-p)):0))),b=Math.max((b||0)-2*(l.padding||0),1),h=(c||0)*rad2deg%180,"parallel"===g&&(h-=90),90<h?h-=180:h<-90&&(h+=180),l.rotation=h),l.textPath&&(0===t.shapeExisting.innerR&&l.textPath.enabled?(l.rotation=0,l.textPath.enabled=!1,b=Math.max(2*t.shapeExisting.r-2*(l.padding||0),1)):t.dlOptions?.textPath&&!t.dlOptions.textPath.enabled&&"circular"===g&&(l.textPath.enabled=!0),l.textPath.enabled&&(l.rotation=0,b=Math.max((u+p)/2-2*(l.padding||0),1),d.whiteSpace="nowrap")),d.width=b+"px",l}function getAnimation(e,t){var r=t.point,s=t.radians,o=t.innerR,i=t.idRoot,n=t.idPreviousRoot,a=t.shapeExisting,l=t.shapeRoot,d=t.shapePreviousRoot,t=t.visible;let p={},u={end:e.end,start:e.start,innerR:e.innerR,r:e.r,x:e.x,y:e.y};return t?!r.graphic&&d&&((p=i===r.id?{start:s.start,end:s.end}:d.end<=e.start?{start:s.end,end:s.end}:{start:s.start,end:s.start}).innerR=p.r=o):r.graphic&&(n===r.id?u={innerR:o,r:o}:l&&(u=l.end<=a.start?{innerR:o,r:o,start:s.end,end:s.end}:{innerR:o,r:o,start:s.start,end:s.start})),{from:p,to:u}}function getDrillId(e,t,r){var s=e.node;let o;return o=s.isLeaf?o:t===e.id?r[t].parent:e.id}function cbSetTreeValuesBefore(e,t){const r=t.mapIdToNode,s=e.parent,o=s?r[s]:void 0,i=t.series,n=i.chart,a=i.points,l=a[e.i],d=i.options.colors||n&&n.options.colors,p=getColor(e,{colors:d,colorIndex:i.colorIndex,index:t.index,mapOptionsToLevel:t.mapOptionsToLevel,parentColor:o&&o.color,parentColorIndex:o&&o.colorIndex,series:t.series,siblings:t.siblings});return e.color=p.color,e.colorIndex=p.colorIndex,l&&(l.color=e.color,l.colorIndex=e.colorIndex,e.sliced=e.id!==t.idRoot&&l.sliced),e}class SunburstSeries extends TreemapSeries{alignDataLabel(e,t,r){if(!r.textPath||!r.textPath.enabled)return t.placed=!1,super.alignDataLabel.apply(this,arguments)}animate(e){const t=this.chart,r=[t.plotWidth/2,t.plotHeight/2],s=t.plotLeft,o=t.plotTop,i=this.group;let n;e?(n={translateX:r[0]+s,translateY:r[1]+o,scaleX:.001,scaleY:.001,rotation:10,opacity:.01},i.attr(n)):(n={translateX:s,translateY:o,scaleX:1,scaleY:1,rotation:0,opacity:1},i.animate(n,this.options.animation))}drawPoints(){const r=this,s=r.mapOptionsToLevel,o=r.shapeRoot,i=r.group,n=r.hasRendered,a=r.rootNode,l=r.idPreviousRoot,d=r.nodeMap,e=d[l],p=e&&e.shapeArgs,t=r.points,u=r.startAndEndRadians,c=r.chart,h=c&&c.options&&c.options.chart||{},g=!isBoolean(h.animation)||h.animation,b=r.center,m={x:b[0],y:b[1]},f=b[3]/2,v=r.chart.renderer,S=!!(g&&n&&a!==l&&r.dataLabelsGroup);let x,R=!1,P=!1;S&&(r.dataLabelsGroup.attr({opacity:0}),x=function(){const e=r;R=!0,e.dataLabelsGroup&&e.dataLabelsGroup.animate({opacity:1,visibility:"inherit"})});for(const y of t){const L=y.node,A=s[L.level],T=y.shapeExisting||{},C=L.shapeArgs||{},I=!(!L.visible||!L.shapeArgs);let e,t;C.borderRadius=r.options.borderRadius,e=n&&g?getAnimation(C,{center:m,point:y,radians:u,innerR:f,idRoot:a,idPreviousRoot:l,shapeExisting:T,shapeRoot:o,shapePreviousRoot:p,visible:I}):{to:C,from:{}},extend(y,{shapeExisting:C,tooltipPos:[C.plotX,C.plotY],drillId:getDrillId(y,a,d),name:""+(y.name||y.id||y.index),plotX:C.plotX,plotY:C.plotY,value:L.val,isInside:I,isNull:!I}),y.dlOptions=getDlOptions({point:y,level:A,optionsPoint:y.options,shapeArgs:C}),!P&&I&&(P=!0,t=x),y.draw({animatableAttribs:e.to,attribs:extend(e.from,!c.styledMode&&r.pointAttribs(y,y.selected&&"select")),onComplete:t,group:i,renderer:v,shapeType:"arc",shapeArgs:C})}S&&P?(r.hasRendered=!1,r.options.dataLabels.defer=!0,ColumnSeries.prototype.drawDataLabels.call(r),r.hasRendered=!0,R&&x()):ColumnSeries.prototype.drawDataLabels.call(r),r.idPreviousRoot=a}layoutAlgorithm(e,t,r){let o=e.start;const i=e.end-o,n=e.val,a=e.x,l=e.y,d=r&&isObject(r.levelSize)&&isNumber(r.levelSize.value)?r.levelSize.value:0,p=e.r,u=p+d,c=r&&isNumber(r.slicedOffset)?r.slicedOffset:0;return(t||[]).reduce((e,t)=>{var r=1/n*t.val*i,s=o+r/2,s=getEndPoint(a,l,s,c),t={x:t.sliced?s.x:a,y:t.sliced?s.y:l,innerR:p,r:u,radius:d,start:o,end:o+r};return e.push(t),o=t.end,e},[])}setRootNode(e,t,r){if(1===this.nodeMap[e].level&&1===this.nodeList.filter(e=>1===e.level).length){if(""===this.idPreviousRoot)return;e=""}super.setRootNode(e,t,r)}setShapeArgs(e,t,r){var s=r[e.level+1],e=e.children.filter(function(e){return e.visible}),o=this.layoutAlgorithm(t,e,s);let i=-1;for(const p of e){var n=o[++i],a=n.start+(n.end-n.start)/2,l=n.innerR+(n.r-n.innerR)/2,d=n.end-n.start,a=0===n.innerR&&6.28<d?{x:n.x,y:n.y}:getEndPoint(n.x,n.y,a,l),l=!p.val||p.childrenTotal>p.val?p.childrenTotal:p.val;this.points[p.i]&&(this.points[p.i].innerArcLength=d*n.innerR,this.points[p.i].outerArcLength=d*n.r),p.shapeArgs=merge(n,{plotX:a.x,plotY:a.y}),p.values=merge(n,{val:l}),p.children.length&&this.setShapeArgs(p,p.values,r)}}translate(){var e=this,t=e.options,r=e.center=e.getCenter(),s=e.startAndEndRadians=getStartAndEndRadians(t.startAngle,t.endAngle),o=r[3]/2,i=r[2]/2-o,n=updateRootId(e);let a=e.nodeMap,l,d=a&&a[n],p={};e.shapeRoot=d&&d.shapeArgs,e.generatePoints(),fireEvent(e,"afterTranslate");var u=e.tree=e.getTree(),c=(a=e.nodeMap,d=a[n],isString(d.parent)?d.parent:""),c=a[c],{from:h,to:g}=SunburstUtilities.getLevelFromAndTo(d),i=(l=getLevelOptions({from:h,levels:e.options.levels,to:g,defaults:{colorByPoint:t.colorByPoint,dataLabels:t.dataLabels,levelIsConstant:t.levelIsConstant,levelSize:t.levelSize,slicedOffset:t.slicedOffset}}),l=SunburstUtilities.calculateLevelSizes(l,{diffRadius:i,from:h,to:g}),setTreeValues(u,{before:cbSetTreeValuesBefore,idRoot:n,levelIsConstant:t.levelIsConstant,mapOptionsToLevel:l,mapIdToNode:a,points:e.points,series:e}),a[""].shapeArgs={end:s.end,r:o,start:s.start,val:d.val,x:r[0],y:r[1]});this.setShapeArgs(c,i,l),e.mapOptionsToLevel=l;for(const b of e.points)p[b.id]&&error(31,!1,e.chart),p[b.id]=!0;p={}}}SunburstSeries.defaultOptions=merge(TreemapSeries.defaultOptions,SunburstSeriesDefaults),extend(SunburstSeries.prototype,{axisTypes:[],drawDataLabels:noop,getCenter:getCenter,isCartesian:!1,onPointSupported:!0,pointAttribs:ColumnSeries.prototype.pointAttribs,pointClass:SunburstPoint,NodeClass:SunburstNode,utils:SunburstUtilities}),SeriesRegistry.registerSeriesType("sunburst",SunburstSeries);export default SunburstSeries;
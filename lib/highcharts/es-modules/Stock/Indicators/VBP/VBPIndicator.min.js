"use strict";import VBPPoint from"./VBPPoint.js";import A from"../../../Core/Animation/AnimationUtilities.js";const animObject=A["animObject"];import H from"../../../Core/Globals.js";const noop=H["noop"];import SeriesRegistry from"../../../Core/Series/SeriesRegistry.js";const{column:{prototype:columnProto},sma:SMAIndicator}=SeriesRegistry.seriesTypes;import U from"../../../Core/Utilities.js";const{addEvent,arrayMax,arrayMin,correctFloat,defined,error,extend,isArray,merge}=U,abs=Math.abs;function arrayExtremesOHLC(e){var t=e.length;let o=e[0][3],a=o,i=1,s;for(;i<t;i++)(s=e[i][3])<o&&(o=s),s>a&&(a=s);return{min:o,max:a}}class VBPIndicator extends SMAIndicator{init(o,e){const a=this,i=(delete e.data,super.init.apply(a,arguments),addEvent(this.chart.constructor,"afterLinkSeries",function(){var e,t;a.options&&(t=a.options.params,e=a.linkedParent,t=o.get(t.volumeSeriesID),a.addCustomEvents(e,t)),i()},{order:1}));return a}addCustomEvents(e,t){const o=this,a=()=>{o.chart.redraw(),o.setData([]),o.zoneStarts=[],o.zoneLinesSVG&&(o.zoneLinesSVG=o.zoneLinesSVG.destroy())};return o.dataEventsToUnbind.push(addEvent(e,"remove",function(){a()})),t&&o.dataEventsToUnbind.push(addEvent(t,"remove",function(){a()})),o}animate(e){const o=this,t=o.chart.inverted,a=o.group,i={};!e&&a&&(e=t?o.yAxis.top:o.xAxis.left,t?(a["forceAnimate:translateY"]=!0,i.translateY=e):(a["forceAnimate:translateX"]=!0,i.translateX=e),a.animate(i,extend(animObject(o.options.animation),{step:function(e,t){o.group.attr({scaleX:Math.max(.001,t.pos)})}})))}drawPoints(){var e=this;e.options.volumeDivision.enabled&&(e.posNegVolume(!0,!0),columnProto.drawPoints.apply(e,arguments),e.posNegVolume(!1,!1)),columnProto.drawPoints.apply(e,arguments)}posNegVolume(e,t){var o=this,a=t?["positive","negative"]:["negative","positive"],i=o.options.volumeDivision,s=o.points.length;let n=[],r=[],l=0,p,d,u,m;for(e?(o.posWidths=n,o.negWidths=r):(n=o.posWidths,r=o.negWidths);l<s;l++)(m=o.points[l])[a[0]+"Graphic"]=m.graphic,m.graphic=m[a[1]+"Graphic"],e&&(p=m.shapeArgs.width,(u=(d=o.priceZones[l]).wholeVolumeData)?(n.push(p/u*d.positiveVolumeData),r.push(p/u*d.negativeVolumeData)):(n.push(0),r.push(0))),m.color=t?i.styles.positiveColor:i.styles.negativeColor,m.shapeArgs.width=(t?o.posWidths:o.negWidths)[l],m.shapeArgs.x=t?m.shapeArgs.x:o.posWidths[l]}translate(){const o=this,e=o.options,t=o.chart,a=o.yAxis,i=a.min,s=o.options.zoneLines,n=o.priceZones;let r=0,l,p,d,u,m,c,h,g,v,f,y;columnProto.translate.apply(o);const x=o.points;x.length&&(g=e.pointPadding<.5?e.pointPadding:.1,l=o.volumeDataArray,p=arrayMax(l),d=t.plotWidth/2,v=t.plotTop,u=abs(a.toPixels(i)-a.toPixels(i+o.rangeStep)),c=abs(a.toPixels(i)-a.toPixels(i+o.rangeStep)),g&&(m=abs(u*(1-2*g)),r=abs((u-m)/2),u=abs(m)),x.forEach(function(e,t){f=e.barX=e.plotX=0,y=e.plotY=a.toPixels(n[t].start)-v-(a.reversed?u-c:u)-r,h=correctFloat(d*n[t].wholeVolumeData/p),e.pointWidth=h,e.shapeArgs=o.crispCol.apply(o,[0,y,h,u]),e.volumeNeg=n[t].negativeVolumeData,e.volumePos=n[t].positiveVolumeData,e.volumeAll=n[t].wholeVolumeData}),s.enabled&&o.drawZones(t,a,o.zoneStarts,s.styles))}getExtremes(){var e=this.options.compare,t=this.options.cumulative;let o;return this.options.compare?(this.options.compare=void 0,o=super.getExtremes(),this.options.compare=e):this.options.cumulative?(this.options.cumulative=!1,o=super.getExtremes(),this.options.cumulative=t):o=super.getExtremes(),o}getValues(e,t){const o=e.getColumn("x",!0),a=e.processedYData,i=this.chart,s=t.ranges,n=[],r=[],l=[],p=i.get(t.volumeSeriesID);if(e.chart){var d;if(!p||!p.getColumn("x",!0).length)return d=p&&!p.getColumn("x",!0).length?" does not contain any data.":" not found! Check `volumeSeriesID`.",void error("Series "+t.volumeSeriesID+d,!0,i);t=isArray(a[0]);if(!t||4===a[0].length){const u=this.priceZones=this.specifyZones(t,o,a,s,p);return u.forEach(function(e,t){n.push([e.x,e.end]),r.push(n[t][0]),l.push(n[t][1])}),{values:n,xData:r,yData:l}}error("Type of "+e.name+" series is different than line, OHLC or candlestick.",!0,i)}else error("Base series not found! In case it has been removed, add a new one.",!0,i)}specifyZones(e,t,o,a,i){const s=this,n=!!e&&arrayExtremesOHLC(o),r=s.zoneStarts=[],l=[];let p=n?n.min:arrayMin(o),d=n?n.max:arrayMax(o),u=0,m=1;const c=s.linkedParent;if(!s.options.compareToMain&&c.dataModify&&(p=c.dataModify.modifyValue(p),d=c.dataModify.modifyValue(d)),!defined(p)||!defined(d))return this.points.length&&(this.setData([]),this.zoneStarts=[],this.zoneLinesSVG&&(this.zoneLinesSVG=this.zoneLinesSVG.destroy())),[];var h=s.rangeStep=correctFloat(d-p)/a;for(r.push(p);u<a-1;u++)r.push(correctFloat(r[u]+h));r.push(d);for(var g=r.length;m<g;m++)l.push({index:m-1,x:t[0],start:r[m-1],end:r[m]});return s.volumePerZone(e,l,i,t,o)}volumePerZone(o,e,t,a,i){const s=this,n=t.getColumn("x",!0),r=t.getColumn("y",!0),l=e.length-1,p=i.length,d=r.length;let u,m,c,h,g;return abs(p-d)&&(a[0]!==n[0]&&r.unshift(0),a[p-1]!==n[d-1]&&r.push(0)),s.volumeDataArray=[],e.forEach(function(e){for(e.wholeVolumeData=0,e.positiveVolumeData=0,e.negativeVolumeData=0,g=0;g<p;g++){m=!1,c=!1,h=o?i[g][3]:i[g],u=g?o?i[g-1][3]:i[g-1]:h;const t=s.linkedParent;!s.options.compareToMain&&t.dataModify&&(h=t.dataModify.modifyValue(h),u=t.dataModify.modifyValue(u)),h<=e.start&&0===e.index&&(m=!0),h>=e.end&&e.index===l&&(c=!0),(h>e.start||m)&&(h<e.end||c)&&(e.wholeVolumeData+=r[g],u>h?e.negativeVolumeData+=r[g]:e.positiveVolumeData+=r[g])}s.volumeDataArray.push(e.wholeVolumeData)}),e}drawZones(t,o,e,a){const i=t.renderer,s=t.plotWidth,n=t.plotTop;let r=this.zoneLinesSVG,l=[],p;e.forEach(function(e){p=o.toPixels(e)-n,l=l.concat(t.renderer.crispLine([["M",0,p],["L",s,p]],a.lineWidth))}),r?r.animate({d:l}):r=this.zoneLinesSVG=i.path(l).attr({"stroke-width":a.lineWidth,stroke:a.color,dashstyle:a.dashStyle,zIndex:this.group.zIndex+.1}).add(this.group)}}VBPIndicator.defaultOptions=merge(SMAIndicator.defaultOptions,{params:{index:void 0,period:void 0,ranges:12,volumeSeriesID:"volume"},zoneLines:{enabled:!0,styles:{color:"#0A9AC9",dashStyle:"LongDash",lineWidth:1}},volumeDivision:{enabled:!0,styles:{positiveColor:"rgba(144, 237, 125, 0.8)",negativeColor:"rgba(244, 91, 91, 0.8)"}},animationLimit:1e3,enableMouseTracking:!1,pointPadding:0,zIndex:-1,crisp:!0,dataGrouping:{enabled:!1},dataLabels:{align:"left",allowOverlap:!0,enabled:!0,format:"P: {point.volumePos:.2f} | N: {point.volumeNeg:.2f}",padding:0,style:{fontSize:"0.5em"},verticalAlign:"top"}}),extend(VBPIndicator.prototype,{nameBase:"Volume by Price",nameComponents:["ranges"],calculateOn:{chart:"render",xAxis:"afterSetExtremes"},pointClass:VBPPoint,markerAttribs:noop,drawGraph:noop,getColumnMetrics:columnProto.getColumnMetrics,crispCol:columnProto.crispCol}),SeriesRegistry.registerSeriesType("vbp",VBPIndicator);export default VBPIndicator;
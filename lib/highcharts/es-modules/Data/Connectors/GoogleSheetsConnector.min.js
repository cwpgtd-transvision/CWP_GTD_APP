"use strict";import DataConnector from"./DataConnector.js";import GoogleSheetsConverter from"../Converters/GoogleSheetsConverter.js";import U from"../../Core/Utilities.js";const{merge,pick,defined}=U;function isGoogleError(e){return"object"==typeof e&&e&&"object"==typeof e.error&&e.error&&"number"==typeof e.error.code&&"string"==typeof e.error.message&&"string"==typeof e.error.status}class GoogleSheetsConnector extends DataConnector{constructor(e,o){e=merge(GoogleSheetsConnector.defaultOptions,e);super(e,o),this.options=defined(o)?merge(e,{dataTables:o}):e}load(o){const t=this,r=t.dataTables,{dataModifier:s,dataRefreshRate:e,enablePolling:n,googleAPIKey:a,googleSpreadsheetKey:i,dataTables:l}=t.options,g=GoogleSheetsConnector.buildFetchURL(a,i,t.options);if(t.emit({type:"load",detail:o,tables:r,url:g}),URL.canParse(g))return fetch(g,{signal:t?.pollingController?.signal}).then(e=>e.json()).then(e=>{if(isGoogleError(e))throw new Error(e.error.message);return this.initConverters(e,o=>{var e=this.options,t=l?.find(e=>e.key===o),t={dataTableKey:o,firstRowAsNames:t?.firstRowAsNames??e.firstRowAsNames,beforeParse:t?.beforeParse??e.beforeParse};return new GoogleSheetsConverter(merge(this.options,t))},(e,o)=>{e.parse({json:o})}),t.setModifierOptions(s,l)}).then(()=>(t.emit({type:"afterLoad",detail:o,tables:r,url:g}),n&&setTimeout(()=>t.load(),1e3*Math.max(e||0,1)),t)).catch(e=>{throw t.emit({type:"loadError",detail:o,error:e,tables:r}),e});throw new Error("Invalid URL: "+g)}}GoogleSheetsConnector.defaultOptions={googleAPIKey:"",googleSpreadsheetKey:"",enablePolling:!1,dataRefreshRate:2,firstRowAsNames:!0},function(e){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function a(e={}){var{endColumn:e,endRow:o,googleSpreadsheetRange:t,startColumn:r,startRow:s}=e;return t||(n[r||0]||"A")+(Math.max(s||0,0)+1)+":"+(n[pick(e,25)]||"Z")+(o?Math.max(o,0):"Z")}e.buildFetchURL=function(e,o,t={}){const r=new URL(`https://sheets.googleapis.com/v4/spreadsheets/${o}/values/`),s=(o=t.onlyColumnNames?"A1:Z1":a(t),r.pathname+=o,r.searchParams);return s.set("alt","json"),t.onlyColumnNames||(s.set("dateTimeRenderOption","FORMATTED_STRING"),s.set("majorDimension","COLUMNS"),s.set("valueRenderOption","UNFORMATTED_VALUE")),s.set("prettyPrint","false"),s.set("key",e),r.href},e.buildQueryRange=a}(GoogleSheetsConnector=GoogleSheetsConnector||{}),DataConnector.registerType("GoogleSheets",GoogleSheetsConnector);export default GoogleSheetsConnector;
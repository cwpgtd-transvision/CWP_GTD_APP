"use strict";import DataConverter from"./DataConverter.js";import U from"../../Core/Utilities.js";const merge=U["merge"];function isRowEqual(e,t){let r=e.length;if(t.length!==r)return!1;for(;--r;)if(e[r]!==t[r])return!1;return!0}class HTMLTableConverter extends DataConverter{constructor(e){e=merge(HTMLTableConverter.defaultOptions,e);super(e),this.columns=[],this.headers=[],(this.options=e).tableElement&&(this.tableElement=e.tableElement,this.tableElementID=e.tableElement.id)}export(e,t=this.options){var r=!1!==t.firstRowAsNames,a=t.useMultiLevelHeaders;const l=e.getSortedColumns(t.usePresentationOrder),s=Object.keys(l),o=[],n=s.length,i=[];let h="";if(r){const c=[];if(a){for(const f of s){let e=l[f];var m=((e=Array.isArray(e)?e:Array.from(e)).shift()||"").toString();l[f]=e,c.push(m)}h=this.getTableHeaderHTML(s,c,t)}else h=this.getTableHeaderHTML(void 0,s,t)}for(let r=0;r<n;r++){var u=s[r],d=l[u],p=d.length;for(let t=0;t<p;t++){let e=d[t];i[t]||(i[t]=[]),"string"!=typeof e&&"number"!=typeof e&&void 0!==e&&(e=(e||"").toString()),i[t][r]=this.getCellHTMLFromValue(r?"td":"th",null,r?"":'scope="row"',e),r===n-1&&o.push("<tr>"+i[t].join("")+"</tr>")}}let g="";return"<table>"+(g=t.tableCaption?'<caption class="highcharts-table-caption">'+t.tableCaption+"</caption>":g)+h+"<tbody>"+o.join("")+"</tbody></table>"}getCellHTMLFromValue(e,t,r,a,l){let s=a,o="text"+(t?" "+t:"");return"number"==typeof s?(s=s.toString(),","===l&&(s=s.replace(".",l)),o="number"):a||(s="",o="empty"),"<"+e+(r?" "+r:"")+' class="'+o+'">'+s+"</"+e+">"}getTableHeaderHTML(e=[],t=[],r=this.options){var{useMultiLevelHeaders:r,useRowspanHeaders:a}=r;let l="<thead>",s=0,o=t&&t.length,n,i=0,h;if(r&&e&&t&&!isRowEqual(e,t)){for(l+="<tr>";s<o;++s)(n=e[s])===e[s+1]?++i:i?(l+=this.getCellHTMLFromValue("th","highcharts-table-topheading",'scope="col" colspan="'+(i+1)+'"',n),i=0):(n===t[s]?a?(h=2,delete t[s]):(h=1,t[s]=""):h=1,l+=this.getCellHTMLFromValue("th","highcharts-table-topheading",'scope="col"'+(1<h?' valign="top" rowspan="'+h+'"':""),n));l+="</tr>"}if(t){for(l+="<tr>",s=0,o=t.length;s<o;++s)void 0!==t[s]&&(l+=this.getCellHTMLFromValue("th",null,'scope="col"',t[s]));l+="</tr>"}return l+="</thead>"}parse(e,t){const s=this,o=[],n=[],i=merge(s.options,e),{endRow:h,startColumn:m,endColumn:u,firstRowAsNames:d}=i,p=i.tableElement||this.tableElement;if(p instanceof HTMLElement){s.tableElement=p,s.tableElementID=p.id,this.emit({type:"parse",columns:s.columns,detail:t,headers:s.headers});var g=p.getElementsByTagName("tr"),c=g.length;let r=0,a,l=i["startRow"];if(d&&c){var f=g[0].children,T=f.length;for(let e=m;e<T&&!(e>u);e++)"TD"!==(a=f[e]).tagName&&"TH"!==a.tagName||n.push(a.innerHTML);l++}for(;r<c;){if(r>=l&&r<=h){var b=g[r].children,H=b.length;let e=0;for(;e<H;){const v=e-m,C=o[v];if(("TD"===(a=b[e]).tagName||"TH"===a.tagName)&&e>=m&&e<=u){o[v]||(o[v]=[]);let e=s.asGuessedType(a.innerHTML),t=(e instanceof Date&&(e=e.getTime()),o[v][r-l]=e,1);for(;r-l>=t&&void 0===C[r-l-t];)C[r-l-t]=null,t++}e++}}r++}this.columns=o,this.headers=n,this.emit({type:"afterParse",columns:o,detail:t,headers:n})}else s.emit({type:"parseError",columns:o,detail:t,headers:n,error:"Not a valid HTML Table"})}getTable(){return DataConverter.getTableFromColumns(this.columns,this.headers)}}HTMLTableConverter.defaultOptions={...DataConverter.defaultOptions,useRowspanHeaders:!0,useMultiLevelHeaders:!0},DataConverter.registerType("HTMLTable",HTMLTableConverter);export default HTMLTableConverter;
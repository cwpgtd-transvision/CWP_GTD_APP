"use strict";import A from"./Animation/AnimationUtilities.js";const animObject=A["animObject"];import F from"./Templating.js";const format=F["format"];import H from"./Globals.js";const{composed,dateFormats,doc,isSafari}=H;import R from"./Renderer/RendererUtilities.js";const distribute=R["distribute"];import RendererRegistry from"./Renderer/RendererRegistry.js";import U from"./Utilities.js";const{addEvent,clamp,css,discardElement,extend,fireEvent,getAlignFactor,isArray,isNumber,isObject,isString,merge,pick,pushUnique,splat,syncTimeout}=U;class Tooltip{constructor(t,e,i){this.allowShared=!0,this.crosshairs=[],this.distance=0,this.isHidden=!0,this.isSticky=!1,this.options={},this.outside=!1,this.chart=t,this.init(t,e),this.pointer=i}bodyFormatter(t){return t.map(t=>{const e=t.series.tooltipOptions,i=t.formatPrefix||"point";return(e[i+"Formatter"]||t.tooltipFormatter).call(t,e[i+"Format"]||"")})}cleanSplit(i){this.chart.series.forEach(function(t){const e=t?.tt;e&&(!e.isActive||i?t.tt=e.destroy():e.isActive=!1)})}defaultFormatter(t){var e=this.points||splat(this);let i;return(i=(i=[t.headerFooterFormatter(e[0])]).concat(t.bodyFormatter(e))).push(t.headerFooterFormatter(e[0],!0)),i}destroy(){this.label&&(this.label=this.label.destroy()),this.split&&(this.cleanSplit(!0),this.tt&&(this.tt=this.tt.destroy())),this.renderer&&(this.renderer=this.renderer.destroy(),discardElement(this.container)),U.clearTimeout(this.hideTimer)}getAnchor(t,o){const{chart:e,pointer:i}=this,r=e.inverted,s=e.plotTop,a=e.plotLeft;let l;if((t=splat(t))[0].series?.yAxis&&!t[0].series.yAxis.options.reversedStacks&&(t=t.slice().reverse()),this.followPointer&&o)void 0===o.chartX&&(o=i.normalize(o)),l=[o.chartX-a,o.chartY-s];else if(t[0].tooltipPos)l=t[0].tooltipPos;else{let e=0,i=0;t.forEach(function(t){t=t.pos(!0);t&&(e+=t[0],i+=t[1])}),e/=t.length,i/=t.length,this.shared&&1<t.length&&o&&(r?e=o.chartX:i=o.chartY),l=[e-a,i-s]}const n={point:t[0],ret:l};return fireEvent(this,"getAnchor",n),n.ret.map(Math.round)}getClassName(t,e,i){const o=this.options,r=t.series,s=r.options;return[o.className,"highcharts-label",i&&"highcharts-tooltip-header",e?"highcharts-tooltip-box":"highcharts-tooltip",!i&&"highcharts-color-"+pick(t.colorIndex,r.colorIndex),s?.className].filter(isString).join(" ")}getLabel({anchorX:t,anchorY:e}={anchorX:0,anchorY:0}){const o=this,i=this.chart.styledMode,r=this.options,s=this.split&&this.allowShared;let a=this.container,l=this.chart.renderer;var n;if(this.label&&(n=!this.label.hasClass("highcharts-label"),(!s&&n||s&&!n)&&this.destroy()),!this.label){if(this.outside){const h=this.chart,c=h.options.chart.style,d=RendererRegistry.getRendererType();this.container=a=H.doc.createElement("div"),a.className="highcharts-tooltip-container "+(h.renderTo.className.match(/(highcharts[a-zA-Z0-9-]+)\s?/gm)||[].join(" ")),css(a,{position:"absolute",top:"1px",pointerEvents:"none",zIndex:Math.max(this.options.style.zIndex||0,(c?.zIndex||0)+3)}),this.renderer=l=new d(a,0,0,c,void 0,void 0,l.styledMode)}if(s?this.label=l.g("tooltip"):(this.label=l.label("",t,e,r.shape||"callout",void 0,void 0,r.useHTML,void 0,"tooltip").attr({padding:r.padding,r:r.borderRadius}),i||this.label.attr({fill:r.backgroundColor,"stroke-width":r.borderWidth||0}).css(r.style).css({pointerEvents:r.style.pointerEvents||(this.shouldStickOnContact()?"auto":"none")})),o.outside){const p=this.label;[p.xSetter,p.ySetter].forEach((e,i)=>{p[i?"ySetter":"xSetter"]=t=>{e.call(p,o.distance),p[i?"y":"x"]=t,a&&(a.style[i?"top":"left"]=t+"px")}})}this.label.attr({zIndex:8}).shadow(r.shadow??!r.fixed).add()}return a&&!a.parentElement&&H.doc.body.appendChild(a),this.label}getPlayingField(){var{body:t,documentElement:e}=doc,{chart:i,distance:o,outside:r}=this;return{width:r?Math.max(t.scrollWidth,e.scrollWidth,t.offsetWidth,e.offsetWidth,e.clientWidth)-2*o-2:i.chartWidth,height:r?Math.max(t.scrollHeight,e.scrollHeight,t.offsetHeight,e.offsetHeight,e.clientHeight):i.chartHeight}}getPosition(i,o,t){const{distance:p,chart:r,outside:g,pointer:e}=this,{inverted:s,plotLeft:a,plotTop:l,polar:n}=r,{plotX:h=0,plotY:c=0}=t,m={},f=s&&t.h||0,{height:d,width:u}=this.getPlayingField(),x=e.getChartPosition(),y=t=>t*x.scaleX,b=t=>t*x.scaleY,v=t=>{var e="x"===t;return[t,e?u:d,e?i:o].concat(g?[e?y(i):b(o),e?x.left-p+y(h+a):x.top-p+b(c+l),0,e?u:d]:[e?i:o,e?h+a:c+l,e?a:l,e?a+r.plotWidth:l+r.plotHeight])};let w=v("y"),F=v("x"),S,T=!!t.negative;!n&&r.hoverSeries?.yAxis?.reversed&&(T=!T);const k=!this.followPointer&&pick(t.ttBelow,!n&&!s===T),P=function(t,e,i,o,r,s,a){var l=g?("y"===t?b:y)(p):p,n=(i-o)/2,h=o<r-p,c=r+p+o<e,d=r-l-i+n,r=r+l-n;if(k&&c)m[t]=r;else if(!k&&h)m[t]=d;else if(h)m[t]=Math.min(a-o,d-f<0?d:d-f);else{if(!c)return m[t]=0,!1;m[t]=Math.max(s,r+f+i>e?r:r+f)}},H=function(t,e,i,o,r){if(r<p||r>e-p)return!1;m[t]=r<i/2?1:e-o/2<r?e-o-2:r-i/2},M=function(t){[w,F]=[F,w],S=t},X=()=>{!1!==P.apply(0,w)?!1!==H.apply(0,F)||S||(M(!0),X()):S?m.x=m.y=0:(M(!0),X())};return(s&&!n||1<this.len)&&M(),X(),m}getFixedPosition(t,e,i){const o=i.series,{chart:r,options:s,split:a}=this,l=s.position,n=l.relativeTo,h=s.shared||o?.yAxis?.isRadial&&("pane"===n||!n),c=h?"plotBox":n,d="chart"===c?r.renderer:r[c]||r.getClipBox(o,!0);return{x:d.x+(d.width-t)*getAlignFactor(l.align)+l.x,y:d.y+(d.height-e)*getAlignFactor(l.verticalAlign)+(!a&&l.y||0)}}hide(e){const i=this;U.clearTimeout(this.hideTimer),e=pick(e,this.options.hideDelay),this.isHidden||(this.hideTimer=syncTimeout(function(){const t=i.getLabel();i.getLabel().animate({opacity:0},{duration:e&&150,complete:()=>{t.hide(),i.container&&i.container.remove()}}),i.isHidden=!0},e))}init(t,e){this.chart=t,this.options=e,this.crosshairs=[],this.isHidden=!0,this.split=e.split&&!t.inverted&&!t.polar,this.shared=e.shared||this.split,this.outside=pick(e.outside,Boolean(t.scrollablePixelsX||t.scrollablePixelsY))}shouldStickOnContact(t){return!(this.followPointer||!this.options.stickOnContact||t&&!this.pointer.inClass(t.target,"highcharts-tooltip"))}move(t,e,i,o){const{followPointer:r,options:s}=this,a=animObject(!r&&!this.isHidden&&!s.fixed&&s.animation),l=r||1<(this.len||0),n={x:t,y:e};l?n.anchorX=n.anchorY=NaN:(n.anchorX=i,n.anchorY=o),a.step=()=>this.drawTracker(),this.getLabel().animate(n,a)}refresh(t,o){const r=this,{chart:s,options:a,pointer:l,shared:e}=this,n=splat(t),h=n[0],i=a.format,c=a.formatter||r.defaultFormatter,d=s.styledMode;var p=r.allowShared;if(a.enabled&&h.series){U.clearTimeout(this.hideTimer),r.allowShared=!(!isArray(t)&&t.series&&t.series.noSharedTooltip),p=p&&!r.allowShared,r.followPointer=!r.split&&h.series.tooltipOptions.followPointer;var t=r.getAnchor(t,o),g=t[0],m=t[1];e&&r.allowShared&&(l.applyInactiveState(n),n.forEach(t=>t.setState("hover")),h.points=n),this.len=n.length;const u=isString(i)?format(i,h,s):c.call(h,r);h.points=void 0;var f=h.series;if(this.distance=pick(f.tooltipOptions.distance,16),!1===u)this.hide();else{if(r.split&&r.allowShared)this.renderSplit(u,n);else{let e=g,i=m;if(o&&l.isDirectTouch&&(e=o.chartX-s.plotLeft,i=o.chartY-s.plotTop),!s.polar&&!1!==f.options.clip&&!n.some(t=>l.isDirectTouch||t.series.shouldShowTooltip(e,i)))return void r.hide();{const x=r.getLabel(p&&r.tt||{});a.style.width&&!d||x.css({width:(this.outside?this.getPlayingField():s.spacingBox).width+"px"}),x.attr({class:r.getClassName(h),text:u&&u.join?u.join(""):u}),this.outside&&x.attr({x:clamp(x.x||0,0,this.getPlayingField().width-(x.width||0)-1)}),d||x.attr({stroke:a.borderColor||h.color||f.color||"#666666"}),r.updatePosition({plotX:g,plotY:m,negative:h.negative,ttBelow:h.ttBelow,series:f,h:t[2]||0})}}r.isHidden&&r.label&&r.label.attr({opacity:1}).show(),r.isHidden=!1}fireEvent(this,"refresh")}}renderSplit(t,c){const d=this,{chart:e,chart:{chartWidth:i,chartHeight:o,plotHeight:p,plotLeft:g,plotTop:m,scrollablePixelsY:r=0,scrollablePixelsX:s,styledMode:f},distance:u,options:x,options:{fixed:y,position:l,positioner:b},pointer:a}=d;var n,{scrollLeft:h=0,scrollTop:v=0}=e.scrollablePlotArea?.scrollingContainer||{};const w=d.outside&&"number"!=typeof s?doc.documentElement.getBoundingClientRect():{left:h,right:h+i,top:v,bottom:v+o},F=d.getLabel(),S=this.renderer||e.renderer,T=Boolean(e.xAxis[0]?.opposite),{left:k,top:P}=a.getChartPosition(),H=b||y;let M=m+v,X,A=p-r;const C=function(t,e,i,o=[0,0],r=!0){let s,a;return i.isHeader?(a=T?0:A,s=clamp(o[0]-t/2,w.left,w.right-t-(d.outside?k:0))):y&&i?(e=d.getFixedPosition(t,e,i),s=e.x,a=e.y-M):(a=o[1]-M,s=r?o[0]-t-u:o[0]+u,s=clamp(s,r?s:w.left,w.right)),{x:s,y:a}};let E=(t=isString(t)?[!1,t]:t).slice(0,c.length+1).reduce(function(t,e,i){if(!1!==e&&""!==e){var i=c[i-1]||{isHeader:!0,plotX:c[0].plotX,plotY:p,series:{}},o=i.isHeader;const n=o?d:i.series,h=n.tt=function(t,e,i){let o=t;var{isHeader:t,series:r}=e,s=r.tooltipOptions||x;if(!o){const a={padding:s.padding,r:s.borderRadius};f||(a.fill=s.backgroundColor,a["stroke-width"]=s.borderWidth??(y&&!t?0:1)),o=S.label("",0,0,s[t?"headerShape":"shape"]||(y&&!t?"rect":"callout"),void 0,void 0,s.useHTML).addClass(d.getClassName(e,!0,t)).attr(a).add(F)}return o.isActive=!0,o.attr({text:i}),f||o.css(s.style).attr({stroke:s.borderColor||e.color||r.color||"#333333"}),o}(n.tt,i,e.toString());var r,e=h.getBBox(),s=e.width+h.strokeWidth(),{anchorX:a,anchorY:l}=(o&&(X=e.height,A+=X,T&&(M-=X)),function(t){const{isHeader:e,plotX:i=0,plotY:o=0,series:r}=t;let s,a;var l;return e?(s=Math.max(g+i,g),a=m+p/2):({xAxis:t,yAxis:l}=r,s=t.pos+clamp(i,-u,t.len+u),r.shouldShowTooltip(0,l.pos-m+o,{ignoreX:!0})&&(a=l.pos+o)),{anchorX:s=clamp(s,w.left-u,w.right+u),anchorY:a}}(i));"number"==typeof l?(e=e.height+1,r=(b||C).call(d,s,e,i,[a,l]),t.push({align:H?0:void 0,anchorX:a,anchorY:l,boxWidth:s,point:i,rank:pick(r.rank,o?1:0),size:e,target:r.y,tt:h,x:r.x})):h.isActive=!1}return t},[]);!H&&E.some(t=>{var e=d["outside"],e=(e?k:0)+t.anchorX;return e<w.left&&e+t.boxWidth<w.right||e<k-w.left+t.boxWidth&&w.right-e>e})&&(E=E.map(t=>{var{x:e,y:i}=C.call(this,t.boxWidth,t.size,t.point,[t.anchorX,t.anchorY],!1);return extend(t,{target:i,x:e})})),d.cleanSplit(),distribute(E,A);const Y={left:k,right:k},{container:L,outside:R,renderer:W}=(E.forEach(function(t){var{x:t,boxWidth:e,isHeader:i}=t;i||(d.outside&&k+t<Y.left&&(Y.left=k+t),!i&&d.outside&&Y.left+e>Y.right&&(Y.right=k+t))}),E.forEach(function(t){var{x:e,anchorX:i,anchorY:o,pos:r,point:{isHeader:s}}=t;const a={visibility:void 0===r?"hidden":"inherit",x:e,y:(r||0)+M+(y&&l.y||0),anchorX:i,anchorY:o};d.outside&&e<i&&(0<(r=k-Y.left)&&(s||(a.x=e+r,a.anchorX=i+r),s&&(a.x=(Y.right-Y.left)/2,a.anchorX=i+r))),t.tt.attr(a)}),d);R&&L&&W&&({width:h,height:v,x:t,y:n}=F.getBBox(),W.setSize(h+t,v+n,!1),L.style.left=Y.left+"px",L.style.top=P+"px"),isSafari&&F.attr({opacity:1===F.opacity?.999:1})}drawTracker(){var t=this;if(this.shouldStickOnContact()){var e=t.chart;const o=t.label;var i=t.shared?e.hoverPoints:e.hoverPoint;if(o&&i){const r={x:0,y:0,width:0,height:0},s=this.getAnchor(i);i=o.getBBox();s[0]+=e.plotLeft-(o.translateX||0),s[1]+=e.plotTop-(o.translateY||0),r.x=Math.min(0,s[0]),r.y=Math.min(0,s[1]),r.width=s[0]<0?Math.max(Math.abs(s[0]),i.width-s[0]):Math.max(Math.abs(s[0]),i.width),r.height=s[1]<0?Math.max(Math.abs(s[1]),i.height-Math.abs(s[1])):Math.max(Math.abs(s[1]),i.height),t.tracker?t.tracker.attr(r):(t.tracker=o.renderer.rect(r).addClass("highcharts-tracker").add(o),e.styledMode||t.tracker.attr({fill:"rgba(0,0,0,0)"}))}}else t.tracker&&(t.tracker=t.tracker.destroy())}styledModeFormat(t){return t.replace('style="font-size: 0.8em"','class="highcharts-header"').replace(/style="color:{(point|series)\.color}"/g,'class="highcharts-color-{$1.colorIndex} {series.options.className} {point.options.className}"')}headerFooterFormatter(e,t){const i=e.series,o=i.tooltipOptions,r=i.xAxis,s=r?.dateTime,a={isFooter:t,point:e};let l=o.xDateFormat||"",n=o[t?"footerFormat":"headerFormat"];return fireEvent(this,"headerFormatter",a,function(t){if(s&&!l&&isNumber(e.key)&&(l=s.getXDateFormat(e.key,o.dateTimeLabelFormats)),s&&l){if(isObject(l)){const format=l;dateFormats[0]=t=>i.chart.time.dateFormat(format,t),l="%0"}(e.tooltipDateKeys||["key"]).forEach(t=>{n=n.replace(new RegExp("point\\."+t+"([ \\)}])"),`(point.${t}:${l})$1`)})}i.chart.styledMode&&(n=this.styledModeFormat(n)),t.text=format(n,e,this.chart)}),a.text||""}update(t){this.destroy(),this.init(this.chart,merge(!0,this.options,t))}updatePosition(t){const{chart:e,container:i,distance:o,options:r,pointer:s,renderer:a}=this,l=this.getLabel(),{height:n=0,width:h=0}=l,{fixed:c,positioner:d}=r,{left:p,top:g,scaleX:m,scaleY:f}=s.getChartPosition(),u=(d||c&&this.getFixedPosition||this.getPosition).call(this,h,n,t),x=H.doc;let y=(t.plotX||0)+e.plotLeft,b=(t.plotY||0)+e.plotTop,v;var w;a&&i&&((d||c)&&({scrollLeft:t=0,scrollTop:w=0}=e.scrollablePlotArea?.scrollingContainer||{},u.x+=t+p-o,u.y+=w+g-o),v=(r.borderWidth||0)+2*o+2,a.setSize(clamp(h+v,0,x.documentElement.clientWidth)-1,n+v,!1),1===m&&1===f||(css(i,{transform:`scale(${m}, ${f})`}),y*=m,b*=f),y+=p-u.x,b+=g-u.y),this.move(Math.round(u.x),Math.round(u.y||0),y,b)}}!function(e){e.compose=function(t){pushUnique(composed,"Core.Tooltip")&&addEvent(t,"afterInit",function(){const t=this.chart;t.options.tooltip&&(t.tooltip=new e(t,t.options.tooltip,this))})}}(Tooltip=Tooltip||{});export default Tooltip;
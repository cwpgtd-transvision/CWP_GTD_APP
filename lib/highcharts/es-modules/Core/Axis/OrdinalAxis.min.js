"use strict";import Axis from"./Axis.js";import DataTableCore from"../../Data/DataTableCore.js";import H from"../Globals.js";import U from"../Utilities.js";const{addEvent,correctFloat,css,defined,error,isNumber,pick,timeUnits,isString}=U;var OrdinalAxis;!function(o){function e(t,i,a,n,o=[],e=0,r){const s={},l=this.options.tickPixelInterval,d=this.chart.time,c=[];let g,p,h,u,f,v=0,x=[],m=-Number.MAX_VALUE;if(!this.options.ordinal&&!this.options.breaks||!o||o.length<3||void 0===i)return d.getTimeTicks.apply(d,arguments);var P=o.length;for(g=0;g<P;g++){if(f=g&&o[g-1]>a,o[g]<i&&(v=g),g===P-1||o[g+1]-o[g]>5*e||f){if(o[g]>m){for(p=d.getTimeTicks(t,o[v],o[g],n);p.length&&p[0]<=m;)p.shift();p.length&&(m=p[p.length-1]),c.push(x.length),x=x.concat(p)}v=g+1}if(f)break}if(p){if(u=p.info,r&&u.unitRange<=timeUnits.hour){for(g=x.length-1,v=1;v<g;v++)d.dateFormat("%d",x[v])!==d.dateFormat("%d",x[v-1])&&(s[x[v]]="day",h=!0);h&&(s[x[0]]="day"),u.higherRanks=s}u.segmentStarts=c,x.info=u}else error(12,!1,this.chart);if(r&&defined(l)){const M=x.length,O=[],R=[];let t,i,n,o,e,r=M;for(;r--;)i=this.translate(x[r]),n&&(R[r]=n-i),O[r]=n=i;for(R.sort((t,i)=>t-i),(o=R[Math.floor(R.length/2)])<.6*l&&(o=null),r=x[M-1]>a?M-1:M,n=void 0;r--;)i=O[r],e=Math.abs(n-i),n&&e<.8*l&&(null===o||e<.8*o)?(s[x[r]]&&!s[x[r+1]]?(t=r+1,n=i):t=r,x.splice(t,1)):n=i}return x}function r(t){var i=this.ordinal.positions;if(!i)return t;let n=i.length-1,o;return t<0?t=i[0]:t>n?t=i[n]:(n=Math.floor(t),o=t-n),void 0!==o&&void 0!==i[n]?i[n]+(o?o*(i[n+1]-i[n]):0):t}function a(t){const i=this,n=i.ordinal,o=(i.old||i).min,e=(i.old||i).transA;var r=n.getExtendedPositions();if(r?.length){var a,s=correctFloat((t-o)*e+i.minPixelPadding),s=correctFloat(n.getIndexOfPoint(s,r)),l=correctFloat(s%1);if(0<=s&&s<=r.length-1)return a=r[Math.floor(s)],a=r[Math.ceil(s)]-a,r[Math.floor(s)]+l*a}return t}function d(t,i){var n=o.Additions.findIndexOf(t,i,!0);return t[n]===i?n:n+(i-t[n])/(t[n+1]-t[n])}function s(){this.ordinal||(this.ordinal=new o.Additions(this))}function l(){var t=this,{eventArgs:i,options:n}=t;t.isXAxis&&defined(n.overscroll)&&0!==n.overscroll&&isNumber(t.max)&&isNumber(t.min)&&(t.options.ordinal&&!t.ordinal.originalOrdinalRange&&t.ordinal.getExtendedPositions(!1),t.max!==t.dataMax||"pan"===i?.trigger&&!t.isInternal||"navigator"===i?.trigger||(n=t.ordinal.convertOverscroll(n.overscroll),t.max+=n,!t.isInternal&&defined(t.userMin)&&"mousewheel"!==i?.trigger&&(t.min+=n)))}function c(){var t=this;t.horiz&&!t.isDirty&&(t.isDirty=t.isOrdinal&&t.chart.navigator&&!t.chart.navigator.adaptToUpdatedData)}function g(){var t=this;t.ordinal&&(t.ordinal.beforeSetTickPositions(),t.tickInterval=t.ordinal.postProcessTickInterval(t.tickInterval))}function p(n){const o=this,e=o.xAxis[0],r=e.ordinal.convertOverscroll(e.options.overscroll),a=n.originalEvent.chartX,t=o.options.chart.panning;let s=!1;if("y"!==t?.type&&e.options.ordinal&&e.series.length&&(!n.touches||n.touches.length<=1)){const l=o.mouseDownX,d=e.getExtremes(),c=d.dataMin,g=d.dataMax,p=d.min,h=d.max,u=o.hoverPoints,f=e.closestPointRange||e.ordinal?.overscrollPointsRange,v=e.translationSlope*(e.ordinal.slope||f),x=Math.round((l-a)/v),m=e.ordinal.getExtendedPositions(),P={ordinal:{positions:m,extendedOrdinalPositions:m}},M=e.index2val,O=e.val2lin;let t,i;if(p<=c&&x<=0||g+r<=h&&0<=x)return void n.preventDefault();P.ordinal.positions?1<Math.abs(x)&&(u&&u.forEach(function(t){t.setState()}),i=P.ordinal.positions,g>(i=r?P.ordinal.positions=i.concat(e.ordinal.getOverscrollPositions()):i)[i.length-1]&&i.push(g),o.setFixedRange(h-p),(t=e.navigatorAxis.toFixedRange(void 0,void 0,M.apply(P,[O.apply(P,[p,!0])+x]),M.apply(P,[O.apply(P,[h,!0])+x]))).min>=Math.min(i[0],p)&&t.max<=Math.max(i[i.length-1],h)+r&&e.setExtremes(t.min,t.max,!0,!1,{trigger:"pan"}),o.mouseDownX=a,css(o.container,{cursor:"move"})):s=!0}else s=!0;s||t&&/y/.test(t.type)?r&&isNumber(e.dataMax)&&(e.max=e.dataMax+r):n.preventDefault()}function h(){const t=this.xAxis;t?.options.ordinal&&(delete t.ordinal.index,delete t.ordinal.originalOrdinalRange)}function u(t,i){const n=this.ordinal,o=n.positions;let e=n.slope,r;if(!o)return t;var a=o.length;let s;if(o[0]<=t&&o[a-1]>=t)s=d(o,t);else{if(!(r=n.getExtendedPositions?.())?.length)return t;var a=r.length,l=(e=e||(r[a-1]-r[0])/a,d(r,o[0]));if(t>=r[0]&&t<=r[a-1])s=d(r,t)-l;else{if(!i)return t;s=t<r[0]?-l-(r[0]-t)/e:(t-r[a-1])/e+a-l}}return i?s:e*(s||0)+n.offset}o.compose=function(t,i,n){const o=t.prototype;return o.ordinal2lin||(o.getTimeTicks=e,o.index2val=r,o.lin2val=a,o.val2lin=u,o.ordinal2lin=o.val2lin,addEvent(t,"afterInit",s),addEvent(t,"foundExtremes",l),addEvent(t,"afterSetScale",c),addEvent(t,"initialAxisTranslation",g),addEvent(n,"pan",p),addEvent(n,"touchpan",p),addEvent(i,"updatedData",h)),t};o.Additions=class{constructor(t){this.index={},this.axis=t}beforeSetTickPositions(){const t=this.axis,i=t.ordinal,n=t.getExtremes(),e=n.min,r=n.max,a=t.brokenAxis?.hasBreaks,o=t.options.ordinal,s=t.options.overscroll&&t.ordinal.convertOverscroll(t.options.overscroll)||0;let l,d,c,g,p,h,u,f=[],v=Number.MAX_VALUE,x=!1,m=!1,P=!1;if(o||a){let o=0;if(t.series.forEach(function(t,i){var n=t.getColumn("x",!0);if(d=[],0<i&&"highcharts-navigator-series"!==t.options.id&&1<n.length&&(m=o!==n[1]-n[0]),o=n[1]-n[0],t.boosted&&(P=t.boosted),t.reserveSpace()&&(!1!==t.takeOrdinalPosition||a)&&(f=f.concat(n),l=f.length,f.sort(function(t,i){return t-i}),v=Math.min(v,pick(t.closestPointRange,v)),l)){for(i=0;i<l-1;)f[i]!==f[i+1]&&d.push(f[i+1]),i++;d[0]!==f[0]&&d.unshift(f[0]),f=d}}),t.ordinal.originalOrdinalRange||(t.ordinal.originalOrdinalRange=(f.length-1)*v),m&&P&&(f.pop(),f.shift()),2<(l=f.length)){for(c=f[1]-f[0],u=l-1;u--&&!x;)f[u+1]-f[u]!=c&&(x=!0);!t.options.keepOrdinalPadding&&(f[0]-e>c||r-s-f[l-1]>c)&&(x=!0)}else t.options.overscroll&&(2===l?v=f[1]-f[0]:1===l?(v=s,f=[f[0],f[0]+v]):v=i.overscrollPointsRange);x||t.forceOrdinal?(t.options.overscroll&&(i.overscrollPointsRange=v,f=f.concat(i.getOverscrollPositions())),i.positions=f,g=t.ordinal2lin(Math.max(e,f[0]),!0),p=Math.max(t.ordinal2lin(Math.min(r,f[f.length-1]),!0),1),i.slope=h=(r-e)/(p-g),i.offset=e-g*h):(i.overscrollPointsRange=pick(t.closestPointRange,i.overscrollPointsRange),i.positions=t.ordinal.slope=i.offset=void 0)}t.isOrdinal=o&&x,i.groupIntervalFactor=null}static findIndexOf(t,i,n){let o=0,e=t.length-1,r;for(;o<e;)t[r=Math.ceil((o+e)/2)]<=i?o=r:e=r-1;return t[o]===i||n?o:-1}getExtendedPositions(n=!0){const o=this,t=o.axis,i=t.constructor.prototype,e=t.chart,r=t.series.reduce((t,i)=>{i=i.currentDataGrouping;return t+(i?i.count+i.unitName:"raw")},""),a=n?t.ordinal.convertOverscroll(t.options.overscroll):0,s=t.getExtremes();let l,d=void 0,c=o.index;return(c=c||(o.index={}))[r]||((l={series:[],chart:e,forceOrdinal:!1,getExtremes:function(){return{min:s.dataMin,max:s.dataMax+a}},applyGrouping:i.applyGrouping,getGroupPixelWidth:i.getGroupPixelWidth,getTimeTicks:i.getTimeTicks,options:{ordinal:!0},ordinal:{getGroupIntervalFactor:this.getGroupIntervalFactor},ordinal2lin:i.ordinal2lin,getIndexOfPoint:i.getIndexOfPoint,val2lin:i.val2lin}).ordinal.axis=l,t.series.forEach(t=>{var i;!1!==t.takeOrdinalPosition&&(d={xAxis:l,chart:e,groupPixelWidth:t.groupPixelWidth,destroyGroupedData:H.noop,getColumn:t.getColumn,applyGrouping:t.applyGrouping,getProcessedData:t.getProcessedData,reserveSpace:t.reserveSpace,visible:t.visible},i=t.getColumn("x").concat(n?o.getOverscrollPositions():[]),d.dataTable=new DataTableCore({columns:{x:i}}),d.options={...t.options,dataGrouping:t.currentDataGrouping?{firstAnchor:t.options.dataGrouping?.firstAnchor,anchor:t.options.dataGrouping?.anchor,lastAnchor:t.options.dataGrouping?.firstAnchor,enabled:!0,forced:!0,approximation:"open",units:[[t.currentDataGrouping.unitName,[t.currentDataGrouping.count]]]}:{enabled:!1}},l.series.push(d),t.processData.apply(d))}),l.applyGrouping({hasExtremesChanged:!0}),d?.closestPointRange!==d?.basePointRange&&d.currentDataGrouping&&(l.forceOrdinal=!0),t.ordinal.beforeSetTickPositions.apply({axis:l}),!t.ordinal.originalOrdinalRange&&l.ordinal.originalOrdinalRange&&(t.ordinal.originalOrdinalRange=l.ordinal.originalOrdinalRange),l.ordinal.positions&&(c[r]=l.ordinal.positions)),c[r]}getGroupIntervalFactor(t,i,n){const o=n.getColumn("x",!0),e=o.length,r=[];let a,s,l=this.groupIntervalFactor;if(!l){for(s=0;s<e-1;s++)r[s]=o[s+1]-o[s];r.sort(function(t,i){return t-i}),a=r[Math.floor(e/2)],t=Math.max(t,o[0]),i=Math.min(i,o[e-1]),this.groupIntervalFactor=l=e*a/(i-t)}return l}getIndexOfPoint(t,i){var n=this.axis,o=n.min,e=n.minPixelPadding,i=d(i,o),o=n.translationSlope*(this.slope||n.closestPointRange||this.overscrollPointsRange);return i+correctFloat((t-e)/o)}getOverscrollPositions(){const t=this.axis,i=this.convertOverscroll(t.options.overscroll),n=this.overscrollPointsRange,o=[];let e=t.dataMax;if(defined(n))for(;e<t.dataMax+i;)e+=n,o.push(e);return o}postProcessTickInterval(t){var i=this.axis,n=this.slope,o=i.closestPointRange;let e;return e=n&&o?i.options.breaks?o||t:t/(n/o):t}convertOverscroll(i=0){function n(t){return pick(o.originalOrdinalRange,defined(e.dataMax)&&defined(e.dataMin)?e.dataMax-e.dataMin:0)*t}const o=this,e=o.axis;if(isString(i)){var r=parseInt(i,10);let t;return defined(e.min)&&defined(e.max)&&defined(e.dataMin)&&defined(e.dataMax)&&((t=e.max-e.min==e.dataMax-e.dataMin)||(this.originalOrdinalRange=e.max-e.min)),/%$/.test(i)?n(r/100):/px/.test(i)?n((r=Math.min(r,.9*e.len)/e.len)/(t?1-r:1)):0}return i}}}(OrdinalAxis=OrdinalAxis||{});export default OrdinalAxis;
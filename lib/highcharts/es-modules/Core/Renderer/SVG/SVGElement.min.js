"use strict";import A from"../../Animation/AnimationUtilities.js";const{animate,animObject,stop}=A;import Color from"../../Color/Color.js";import H from"../../Globals.js";const{deg2rad,doc,svg,SVG_NS,win,isFirefox}=H;import U from"../../Utilities.js";const{addEvent,attr,createElement,crisp,css,defined,erase,extend,fireEvent,getAlignFactor,isArray,isFunction,isNumber,isObject,isString,merge,objectEach,pick,pInt,pushUnique,replaceNested,syncTimeout,uniqueKey}=U;class SVGElement{_defaultGetter(t){let e=pick(this[t+"Value"],this[t],this.element?this.element.getAttribute(t):null,0);return e=/^-?[\d\.]+$/.test(e)?parseFloat(e):e}_defaultSetter(t,e,i){i.setAttribute(e,t)}add(t){const e=this.renderer,i=this.element;let r;return t&&(this.parentGroup=t),void 0!==this.textStr&&"text"===this.element.nodeName&&e.buildText(this),this.added=!0,(r=t&&!t.handleZ&&!this.zIndex?r:this.zIndexSetter())||(t?t.element:e.box).appendChild(i),this.onAdd&&this.onAdd(),this}addClass(t,e){const i=!e&&this.attr("class")||"";return(t=(t||"").split(/ /g).reduce(function(t,e){return-1===i.indexOf(e)&&t.push(e),t},i?[i]:[]).join(" "))!==i&&this.attr("class",t),this}afterSetters(){this.doTransform&&(this.updateTransform(),this.doTransform=!1)}align(t,e,i,r=!0){var n=this.renderer,s=n.alignedObjects,o=Boolean(t),a=(t?(this.alignOptions=t,this.alignByTranslate=e,this.alignTo=i):(t=this.alignOptions||{},e=this.alignByTranslate,i=this.alignTo),!i||isString(i)?i||"renderer":void 0);a&&(o&&pushUnique(s,this),i=void 0);const l=pick(i,n[a],n),h=(l.x||0)+(t.x||0)+((l.width||0)-(t.width||0))*getAlignFactor(t.align),d=(l.y||0)+(t.y||0)+((l.height||0)-(t.height||0))*getAlignFactor(t.verticalAlign),c={"text-align":t?.align};return c[e?"translateX":"x"]=Math.round(h),c[e?"translateY":"y"]=Math.round(d),r&&(this[this.placed?"animate":"attr"](c),this.placed=!0),this.alignAttr=c,this}alignSetter(t){var e={left:"start",center:"middle",right:"end"};e[t]&&(this.alignValue=t,this.element.setAttribute("text-anchor",e[t]))}animate(t,e,i){const r=animObject(pick(e,this.renderer.globalAnimation,!0)),n=r.defer;return doc.hidden&&(r.duration=0),0!==r.duration?(i&&(r.complete=i),syncTimeout(()=>{this.element&&animate(this,t,r)},n)):(this.attr(t,void 0,i||r.complete),objectEach(t,function(t,e){r.step&&r.step.call(this,t,{prop:e,pos:1,elem:this})},this)),this}applyTextOutline(t){const i=this.element,e=-1!==t.indexOf("contrast");var r=(t=e?t.replace(/contrast/g,this.renderer.getContrast(i.style.fill)):t).indexOf(" "),n=t.substring(r+1);let s=t.substring(0,r);if(s&&"none"!==s&&H.svg){this.fakeTS=!0,s=s.replace(/(^[\d\.]+)(.*?)$/g,function(t,e,i){return 2*Number(e)+i}),this.removeTextOutline();const o=doc.createElementNS(SVG_NS,"tspan"),a=(attr(o,{class:"highcharts-text-outline",fill:n,stroke:n,"stroke-width":s,"stroke-linejoin":"round"}),i.querySelector("textPath")||i);[].forEach.call(a.childNodes,t=>{const e=t.cloneNode(!0);e.removeAttribute&&["fill","stroke","stroke-width","stroke"].forEach(t=>e.removeAttribute(t)),o.appendChild(e)});let e=0;[].forEach.call(a.querySelectorAll("text tspan"),t=>{e+=Number(t.getAttribute("dy"))});const l=doc.createElementNS(SVG_NS,"tspan");l.textContent="â€‹",attr(l,{x:Number(i.getAttribute("x")),dy:-e}),o.appendChild(l),a.insertBefore(o,a.firstChild)}}attr(i,t,e,r){const n=this["element"],s=SVGElement.symbolCustomAttribs;let o,a,l=this,h,d;return"string"==typeof i&&void 0!==t&&(o=i,(i={})[o]=t),"string"==typeof i?l=(this[i+"Getter"]||this._defaultGetter).call(this,i,n):(objectEach(i,function(t,e){h=!1,r||stop(this,e),this.symbolName&&-1!==s.indexOf(e)&&(a||(this.symbolAttr(i),a=!0),h=!0),!this.rotation||"x"!==e&&"y"!==e||(this.doTransform=!0),h||(d=this[e+"Setter"]||this._defaultSetter).call(this,t,e,n)},this),this.afterSetters()),e&&e.call(this),l}clip(t){var e,i;return t&&!t.clipPath&&(e=uniqueKey()+"-",i=this.renderer.createElement("clipPath").attr({id:e}).add(this.renderer.defs),extend(t,{clipPath:i,id:e,count:0}),t.add(i)),this.attr("clip-path",t?`url(${this.renderer.url}#${t.id})`:"none")}crisp(t,e){e=Math.round(e||t.strokeWidth||0);var i=t.x||this.x||0,r=t.y||this.y||0,n=(t.width||this.width||0)+i,s=(t.height||this.height||0)+r,i=crisp(i,e),r=crisp(r,e),n=crisp(n,e),s=crisp(s,e);return extend(t,{x:i,y:r,width:n-i,height:s-r}),defined(t.strokeWidth)&&(t.strokeWidth=e),t}complexColor(t,i,r){const n=this.renderer;let s,o,a,l,h,d,c,p,u,m,g=[],f;fireEvent(this.renderer,"complexColor",{args:arguments},function(){if(t.radialGradient?o="radialGradient":t.linearGradient&&(o="linearGradient"),o){if(a=t[o],h=n.gradients,d=t.stops,u=r.radialReference,isArray(a)&&(t[o]=a={x1:a[0],y1:a[1],x2:a[2],y2:a[3],gradientUnits:"userSpaceOnUse"}),"radialGradient"===o&&u&&!defined(a.gradientUnits)&&(l=a,a=merge(a,n.getRadialAttr(u,l),{gradientUnits:"userSpaceOnUse"})),objectEach(a,function(t,e){"id"!==e&&g.push(e,t)}),objectEach(d,function(t){g.push(t)}),g=g.join(","),h[g])m=h[g].attr("id");else{a.id=m=uniqueKey();const e=h[g]=n.createElement(o).attr(a).add(n.defs);e.radAttr=l,e.stops=[],d.forEach(function(t){p=0===t[1].indexOf("rgba")?(s=Color.parse(t[1]),c=s.get("rgb"),s.get("a")):(c=t[1],1);t=n.createElement("stop").attr({offset:t[0],"stop-color":c,"stop-opacity":p}).add(e);e.stops.push(t)})}f="url("+n.url+"#"+m+")",r.setAttribute(i,f),r.gradient=g,t.toString=function(){return f}}})}css(t){const i=this.styles,r={},e=this.element;let n,s=!i;if(i&&objectEach(t,function(t,e){i&&i[e]!==t&&(r[e]=t,s=!0)}),s){null===(t=i?extend(i,r):t).width||"auto"===t.width?delete this.textWidth:"text"===e.nodeName.toLowerCase()&&t.width&&(n=this.textWidth=pInt(t.width)),extend(this.styles,t),n&&!svg&&this.renderer.forExport&&delete t.width;var o=isFirefox&&t.fontSize||null;o&&(isNumber(o)||/^\d+$/.test(o))&&(t.fontSize+="px");const a=merge(t);e.namespaceURI===this.SVG_NS&&(["textOutline","textOverflow","whiteSpace","width"].forEach(t=>a&&delete a[t]),a.color&&(a.fill=a.color,delete a.color)),css(e,a)}return this.added&&("text"===this.element.nodeName&&this.renderer.buildText(this),t.textOutline&&this.applyTextOutline(t.textOutline)),this}dashstyleSetter(t){let e,i=this["stroke-width"];if("inherit"===i&&(i=1),t){const r=(t=t.toLowerCase()).replace("shortdashdotdot","3,1,1,1,1,1,").replace("shortdashdot","3,1,1,1").replace("shortdot","1,1,").replace("shortdash","3,1,").replace("longdash","8,3,").replace(/dot/g,"1,3,").replace("dash","4,3,").replace(/,$/,"").split(",");for(e=r.length;e--;)r[e]=""+pInt(r[e])*pick(i,NaN);t=r.join(",").replace(/NaN/g,"none"),this.element.setAttribute("stroke-dasharray",t)}}destroy(){const i=this,t=i.element||{},e=i.renderer,r=t.ownerSVGElement;let n="SPAN"===t.nodeName&&i.parentGroup||void 0,s,o;if(t.onclick=t.onmouseout=t.onmouseover=t.onmousemove=t.point=null,stop(i),i.clipPath&&r){const a=i.clipPath;[].forEach.call(r.querySelectorAll("[clip-path],[CLIP-PATH]"),function(t){-1<t.getAttribute("clip-path").indexOf(a.element.id)&&t.removeAttribute("clip-path")}),i.clipPath=a.destroy()}if(i.stops){for(o=0;o<i.stops.length;o++)i.stops[o].destroy();i.stops.length=0,i.stops=void 0}for(i.safeRemoveChild(t);n?.div&&0===n.div.childNodes.length;)s=n.parentGroup,i.safeRemoveChild(n.div),delete n.div,n=s;i.alignOptions&&erase(e.alignedObjects,i),objectEach(i,(t,e)=>{i[e]?.parentGroup!==i&&-1===["connector","foreignObject"].indexOf(e)||i[e]?.destroy?.(),delete i[e]})}dSetter(t,e,i){isArray(t)&&("string"==typeof t[0]&&(t=this.renderer.pathToSegments(t)),t=(this.pathArray=t).reduce((t,e,i)=>e?.join?(i?t+" ":"")+e.join(" "):(e||"").toString(),"")),/(NaN| {2}|^$)/.test(t)&&(t="M 0 0"),this[e]!==t&&(i.setAttribute(e,t),this[e]=t)}fillSetter(t,e,i){"string"==typeof t?i.setAttribute(e,t):t&&this.complexColor(t,e,i)}hrefSetter(t,e,i){i.setAttributeNS("http://www.w3.org/1999/xlink",e,t)}getBBox(t,e){const i=this,{alignValue:r,element:n,renderer:s,styles:o,textStr:a}=i,{cache:l,cacheKeys:h}=s,d=n.namespaceURI===i.SVG_NS,c=pick(e,i.rotation,0),p=s.styledMode?n&&SVGElement.prototype.getStyle.call(n,"font-size"):o.fontSize;let u,m,g,f;if(defined(a)&&(-1===(f=a.toString()).indexOf("<")&&(f=f.replace(/\d/g,"0")),f+=["",s.rootFontSize,p,c,i.textWidth,r,o.lineClamp,o.textOverflow,o.fontWeight].join(",")),!(u=f&&!t?l[f]:u)||u.polygon){if(d||s.forExport){try{g=this.fakeTS&&function(t){var e=n.querySelector(".highcharts-text-outline");e&&css(e,{display:t})},isFunction(g)&&g("none"),u=n.getBBox?extend({},n.getBBox()):{width:n.offsetWidth,height:n.offsetHeight,x:0,y:0},isFunction(g)&&g("")}catch(t){}(!u||u.width<0)&&(u={x:0,y:0,width:0,height:0})}else u=i.htmlGetBBox();m=u.height,d&&(u.height=m={"11px,17":14,"13px,20":16}[`${p||""},`+Math.round(m)]||m);e={bBox:u=c?this.getRotatedBox(u,c):u};fireEvent(this,"afterGetBBox",e),u=e.bBox}if(f&&(""===a||0<u.height)){for(;250<h.length;)delete l[h.shift()];l[f]||h.push(f),l[f]=u}return u}getRotatedBox(t,e){const{x:i,y:r,width:n,height:s}=t,{alignValue:o,translateY:a,rotationOriginX:l=0,rotationOriginY:h=0}=this,d=getAlignFactor(o),c=Number(this.element.getAttribute("y")||0)-(a?0:r),p=e*deg2rad,u=(e-90)*deg2rad,m=Math.cos(p),g=Math.sin(p),f=n*m,x=n*g,S=Math.cos(u),y=Math.sin(u),[[b,A],[v,E]]=[l,h].map(t=>[t-t*m,t*g]),G=i+d*(n-f)+b+E,N=r+c-d*x-A+v,w=G+c*S,O=w+f,C=O-s*S,V=C-f,k=N+c*y,B=k+x,j=B-s*y,T=j-x;t=Math.min(w,O,C,V),e=Math.min(k,B,j,T);return{x:t,y:e,width:Math.max(w,O,C,V)-t,height:Math.max(k,B,j,T)-e,polygon:[[w,k],[O,B],[C,j],[V,T]]}}getStyle(t){return win.getComputedStyle(this.element||this,"").getPropertyValue(t)}hasClass(t){return-1!==(""+this.attr("class")).split(" ").indexOf(t)}hide(){return this.attr({visibility:"hidden"})}htmlGetBBox(){return{height:0,width:0,x:0,y:0}}constructor(t,e){this.onEvents={},this.opacity=1,this.SVG_NS=SVG_NS,this.element="span"===e||"body"===e?createElement(e):doc.createElementNS(this.SVG_NS,e),this.renderer=t,this.styles={},fireEvent(this,"afterInit")}on(t,e){const i=this["onEvents"];return i[t]&&i[t](),i[t]=addEvent(this.element,t,e),this}opacitySetter(t,e,i){t=Number(Number(t).toFixed(3));this.opacity=t,i.setAttribute(e,t)}reAlign(){this.alignOptions?.width&&"left"!==this.alignOptions.align&&(this.alignOptions.width=this.getBBox().width,this.placed=!1,this.align())}removeClass(t){return this.attr("class",(""+this.attr("class")).replace(isString(t)?new RegExp(`(^| )${t}( |$)`):t," ").replace(/ +/g," ").trim())}removeTextOutline(){var t=this.element.querySelector("tspan.highcharts-text-outline");t&&this.safeRemoveChild(t)}safeRemoveChild(t){const e=t.parentNode;e&&e.removeChild(t)}setRadialReference(t){const e=this.element.gradient&&this.renderer.gradients[this.element.gradient]||void 0;return this.element.radialReference=t,e?.radAttr&&e.animate(this.renderer.getRadialAttr(t,e.radAttr)),this}shadow(t){const e=this["renderer"],i=merge(90===this.parentGroup?.rotation?{offsetX:-1,offsetY:-1}:{},isObject(t)?t:{}),r=e.shadowDefinition(i);return this.attr({filter:t?`url(${e.url}#${r})`:"none"})}show(t=!0){return this.attr({visibility:t?"inherit":"visible"})}"stroke-widthSetter"(t,e,i){this[e]=t,i.setAttribute(e,t)}strokeWidth(){if(!this.renderer.styledMode)return this["stroke-width"]||0;var t=this.getStyle("stroke-width");let e=0,i;return/px$/.test(t)?e=pInt(t):""!==t&&(i=doc.createElementNS(SVG_NS,"rect"),attr(i,{width:t,"stroke-width":0}),this.element.parentNode.appendChild(i),e=i.getBBox().width,i.parentNode.removeChild(i)),e}symbolAttr(e){const i=this;SVGElement.symbolCustomAttribs.forEach(function(t){i[t]=pick(e[t],i[t])}),i.attr({d:i.renderer.symbols[i.symbolName](i.x,i.y,i.width,i.height,i)})}textSetter(t){t!==this.textStr&&(delete this.textPxLength,this.textStr=t,this.added&&this.renderer.buildText(this),this.reAlign())}titleSetter(t){const e=this.element,i=e.getElementsByTagName("title")[0]||doc.createElementNS(this.SVG_NS,"title");e.insertBefore?e.insertBefore(i,e.firstChild):e.appendChild(i),i.textContent=replaceNested(pick(t,""),[/<[^>]*>/g,""]).replace(/&lt;/g,"<").replace(/&gt;/g,">")}toFront(){const t=this.element;return t.parentNode.appendChild(t),this}translate(t,e){return this.attr({translateX:t,translateY:e})}updateTransform(t="transform"){const{element:e,foreignObject:i,matrix:r,padding:n,rotation:s=0,rotationOriginX:o,rotationOriginY:a,scaleX:l,scaleY:h,text:d,translateX:c=0,translateY:p=0}=this,u=["translate("+c+","+p+")"];defined(r)&&u.push("matrix("+r.join(",")+")"),s&&(u.push("rotate("+s+" "+(o??e.getAttribute("x")??this.x??0)+" "+(a??e.getAttribute("y")??this.y??0)+")"),"SPAN"!==d?.element.tagName||d?.foreignObject||d.attr({rotation:s,rotationOriginX:(o||0)-n,rotationOriginY:(a||0)-n})),(defined(l)||defined(h))&&u.push("scale("+pick(l,1)+" "+pick(h,1)+")"),u.length&&!(d||this).textPath&&(i?.element||e).setAttribute(t,u.join(" "))}visibilitySetter(t,e,i){"inherit"===t?i.removeAttribute(e):this[e]!==t&&i.setAttribute(e,t),this[e]=t}xGetter(t){return"circle"===this.element.nodeName&&("x"===t?t="cx":"y"===t&&(t="cy")),this._defaultGetter(t)}zIndexSetter(t,e){const i=this.renderer,r=this.parentGroup,n=r||i,s=n.element||i.box,o=this.element,a=s===i.box;let l,h,d,c=!1,p,u=this.added,m;if(defined(t)?(o.setAttribute("data-z-index",t),this[e]===(t=+t)&&(u=!1)):defined(this[e])&&o.removeAttribute("data-z-index"),this[e]=t,u){for((t=this.zIndex)&&r&&(r.handleZ=!0),l=s.childNodes,m=l.length-1;0<=m&&!c;m--)d=(h=l[m]).getAttribute("data-z-index"),p=!defined(d),h!==o&&(t<0&&p&&!a&&!m?(s.insertBefore(o,l[m]),c=!0):(pInt(d)<=t||p&&(!defined(t)||0<=t))&&(s.insertBefore(o,l[m+1]),c=!0));c||(s.insertBefore(o,l[a?3:0]),c=!0)}return c}}SVGElement.symbolCustomAttribs=["anchorX","anchorY","clockwise","end","height","innerR","r","start","width","x","y"],SVGElement.prototype.strokeSetter=SVGElement.prototype.fillSetter,SVGElement.prototype.yGetter=SVGElement.prototype.xGetter,SVGElement.prototype.matrixSetter=SVGElement.prototype.rotationOriginXSetter=SVGElement.prototype.rotationOriginYSetter=SVGElement.prototype.rotationSetter=SVGElement.prototype.scaleXSetter=SVGElement.prototype.scaleYSetter=SVGElement.prototype.translateXSetter=SVGElement.prototype.translateYSetter=SVGElement.prototype.verticalAlignSetter=function(t,e){this[e]=t,this.doTransform=!0};export default SVGElement;
"use strict";import AST from"../HTML/AST.js";import H from"../../Globals.js";const{doc,SVG_NS,win}=H;import U from"../../Utilities.js";const{attr,extend,fireEvent,isString,objectEach,pick}=U,stringWithEllipsis=(t,e)=>t.substring(0,e)+"…";class TextBuilder{constructor(t){var e=t.styles;this.renderer=t.renderer,this.svgElement=t,this.width=t.textWidth,this.textLineHeight=e?.lineHeight,this.textOutline=e?.textOutline,this.ellipsis=Boolean("ellipsis"===e?.textOverflow),this.lineClamp=e?.lineClamp,this.noWrap=Boolean("nowrap"===e?.whiteSpace)}buildSVG(){const t=this.svgElement,e=t.element,i=t.renderer,n=pick(t.textStr,"").toString(),s=-1!==n.indexOf("<"),r=e.childNodes,l=!t.added&&i.box,o=[n,this.ellipsis,this.noWrap,this.textLineHeight,this.textOutline,t.getStyle("font-size"),t.styles.lineClamp,this.width].join(",");if(o!==t.textCache){t.textCache=o,delete t.actualWidth;for(let t=r.length;t--;)e.removeChild(r[t]);if(s||this.ellipsis||this.width||t.textPath||-1!==n.indexOf(" ")&&(!this.noWrap||/<br.*?>/g.test(n))){if(""!==n){l&&l.appendChild(e);const h=new AST(n);this.modifyTree(h.nodes),h.addToDOM(e),this.modifyDOM(),this.ellipsis&&-1!==(e.textContent||"").indexOf("…")&&t.attr("title",this.unescapeEntities(t.textStr||"",["&lt;","&gt;"])),l&&l.removeChild(e)}}else e.appendChild(doc.createTextNode(this.unescapeEntities(n)));isString(this.textOutline)&&t.applyTextOutline&&t.applyTextOutline(this.textOutline)}}modifyDOM(){const d=this.svgElement,g=attr(d.element,"x");var t;for(d.firstLineMetrics=void 0;(t=d.element.firstChild)&&/^[\s\u200B]*$/.test(t.textContent||" ");)d.element.removeChild(t);[].forEach.call(d.element.querySelectorAll("tspan.highcharts-br"),(t,e)=>{t.nextSibling&&t.previousSibling&&(0===e&&1===t.previousSibling.nodeType&&(d.firstLineMetrics=d.renderer.fontMetrics(t.previousSibling)),attr(t,{dy:this.getLineHeight(t.nextSibling),x:g}))});const p=this.width||0;if(p){const i=(i,n)=>{const t=i.textContent||"",s=t.replace(/([^\^])-/g,"$1- ").split(" ");var e=!this.noWrap&&(1<s.length||1<d.element.childNodes.length);const r=this.getLineHeight(n),l=Math.max(0,p-.8*r);let o=0,h=d.actualWidth;if(e){const a=[],c=[];for(;n.firstChild&&n.firstChild!==i;)c.push(n.firstChild),n.removeChild(n.firstChild);for(;s.length;)if(s.length&&!this.noWrap&&0<o&&(a.push(i.textContent||""),i.textContent=s.join(" ").replace(/- /g,"-")),this.truncate(i,void 0,s,0===o&&h||0,p,l,(t,e)=>s.slice(0,e).join(" ").replace(/- /g,"-")),h=d.actualWidth,o++,this.lineClamp&&o>=this.lineClamp){s.length&&(this.truncate(i,i.textContent||"",void 0,0,p,l,stringWithEllipsis),i.textContent=i.textContent?.replace("…","")+"…");break}c.forEach(t=>{n.insertBefore(t,i)}),a.forEach(t=>{n.insertBefore(doc.createTextNode(t),i);const e=doc.createElementNS(SVG_NS,"tspan");e.textContent="​",attr(e,{dy:r,x:g}),n.insertBefore(e,i)})}else this.ellipsis&&t&&this.truncate(i,t,void 0,0,p,l,stringWithEllipsis)},n=e=>{const t=[].slice.call(e.childNodes);t.forEach(t=>{t.nodeType===win.Node.TEXT_NODE?i(t,e):(-1!==t.className.baseVal.indexOf("highcharts-br")&&(d.actualWidth=0),n(t))})};n(d.element)}}getLineHeight(t){t=t.nodeType===win.Node.TEXT_NODE?t.parentElement:t;return this.textLineHeight?parseInt(this.textLineHeight.toString(),10):this.renderer.fontMetrics(t||this.svgElement.element).h}modifyTree(h){const a=(t,e)=>{const{attributes:i={},children:n,style:s={},tagName:r}=t,l=this.renderer.styledMode;if("b"===r||"strong"===r?l?i.class="highcharts-strong":s.fontWeight="bold":"i"!==r&&"em"!==r||(l?i.class="highcharts-emphasized":s.fontStyle="italic"),s?.color&&(s.fill=s.color),"br"===r){i.class="highcharts-br",t.textContent="​";const o=h[e+1];o?.textContent&&(o.textContent=o.textContent.replace(/^ +/gm,""))}else"a"===r&&n&&n.some(t=>"#text"===t.tagName)&&(t.children=[{children:n,tagName:"tspan"}]);"#text"!==r&&"a"!==r&&(t.tagName="tspan"),extend(t,{attributes:i,style:s}),n&&n.filter(t=>"#text"!==t.tagName).forEach(a)};h.forEach(a),fireEvent(this.svgElement,"afterModifyTree",{nodes:h})}truncate(n,t,s,r,e,i,l){const o=this.svgElement;var h=o["rotation"];const a=[];let c=s&&!r?1:0,d=(t||s||"").length,g=d,p,x;s||(e=i);function f(t,e){e=e||t;const i=n.parentNode;if(i&&void 0===a[e]&&i.getSubStringLength)try{a[e]=r+i.getSubStringLength(0,s?e+1:e)}catch(t){}return a[e]}if(o.rotation=0,x=f(n.textContent.length),r+x>e){for(;c<=d;)g=Math.ceil((c+d)/2),s&&(p=l(s,g)),x=f(g,p&&p.length-1),c===d?c=d+1:x>e?d=g-1:c=g;0===d?n.textContent="":t&&d===t.length-1||(n.textContent=p||l(t||s,g)),this.ellipsis&&x>e&&this.truncate(n,n.textContent||"",void 0,0,e,i,stringWithEllipsis)}s&&s.splice(0,g),o.actualWidth=x,o.rotation=h}unescapeEntities(i,n){return objectEach(this.renderer.escapes,function(t,e){n&&-1!==n.indexOf(t)||(i=i.toString().replace(new RegExp(t,"g"),e))}),i}}export default TextBuilder;
"use strict";import AST from"./AST.js";import H from"../../Globals.js";const{composed,isFirefox}=H;import SVGElement from"../SVG/SVGElement.js";import U from"../../Utilities.js";const{attr,css,createElement,defined,extend,getAlignFactor,isNumber,pInt,pushUnique}=U;function commonSetter(t,e,i){const s=this.div?.style;SVGElement.prototype[e+"Setter"].call(this,t,e,i),s&&(i.style[e]=s[e]=t)}const decorateSVGGroup=(i,t)=>{if(!i.div){const e=attr(i.element,"class"),s=i.css,r=createElement("div",e?{className:e}:void 0,{position:"absolute",left:`${i.translateX||0}px`,top:`${i.translateY||0}px`,...i.styles,display:i.display,opacity:i.opacity,visibility:i.visibility},i.parentGroup?.div||t);i.classSetter=(t,e,i)=>{i.setAttribute("class",t),r.className=t},i.translateXSetter=i.translateYSetter=(t,e)=>{i[e]=t,r.style["translateX"===e?"left":"top"]=t+"px",i.doTransform=!0},i.scaleXSetter=i.scaleYSetter=(t,e)=>{i[e]=t,i.doTransform=!0},i.opacitySetter=i.visibilitySetter=commonSetter,i.css=t=>(s.call(i,t),t.cursor&&(r.style.cursor=t.cursor),t.pointerEvents&&(r.style.pointerEvents=t.pointerEvents),i),i.on=function(){return SVGElement.prototype.on.apply({element:r,onEvents:i.onEvents},arguments),i},i.div=r}return i.div};class HTMLElement extends SVGElement{static compose(t){pushUnique(composed,this.compose)&&(t.prototype.html=function(t,e,i){return new HTMLElement(this,"span").attr({text:t,x:Math.round(e),y:Math.round(i)})})}constructor(t,e){super(t,e),HTMLElement.useForeignObject?this.foreignObject=t.createElement("foreignObject").attr({zIndex:2}):this.css({position:"absolute",...t.styledMode?{}:{fontFamily:t.style.fontFamily,fontSize:t.style.fontSize}}),this.element.style.whiteSpace="nowrap"}getSpanCorrection(t,e,i){this.xCorr=-t*i,this.yCorr=-e}css(t){var e=this["element"],i="SPAN"===e.tagName&&t&&"width"in t,s=i&&t.width;let r;return i&&(delete t.width,this.textWidth=pInt(s)||void 0,r=!0),"ellipsis"===t?.textOverflow&&(t.overflow="hidden",t.whiteSpace="nowrap"),t?.lineClamp&&(t.display="-webkit-box",t.WebkitLineClamp=t.lineClamp,t.WebkitBoxOrient="vertical",t.overflow="hidden"),isNumber(Number(t?.fontSize))&&(t.fontSize+="px"),extend(this.styles,t),css(e,t),r&&this.updateTransform(),this}htmlGetBBox(){var t=this["element"];return{x:t.offsetLeft,y:t.offsetTop,width:t.offsetWidth,height:t.offsetHeight}}updateTransform(){if(!this.added)return void(this.alignOnAdd=!0);const{element:t,foreignObject:e,oldTextWidth:i,renderer:s,rotation:r,rotationOriginX:o,rotationOriginY:n,scaleX:a,scaleY:l,styles:{display:d="inline-block",whiteSpace:p},textAlign:h="left",textWidth:c,translateX:m=0,translateY:f=0,x=0,y:u=0}=this;var g=()=>this.textPxLength||(css(t,{width:"",whiteSpace:p||"nowrap"}),t.offsetWidth);if(e||css(t,{marginLeft:m+"px",marginTop:f+"px"}),"SPAN"===t.tagName){var S,y,b=[r,h,t.innerHTML,c,this.textAlign].join(","),v=-1*this.parentGroup?.padding||0;c!==i&&(g=g(),y=c||0,S=""===t.style.textOverflow&&t.style.webkitLineClamp,(i<y||y<g||S)&&(/[\-\s\u00AD]/.test(t.textContent||t.innerText)||"ellipsis"===t.style.textOverflow)&&(y=r||a||y<g||S,css(t,{width:y&&isNumber(c)?c+"px":"auto",display:d,whiteSpace:p||"normal"}),this.oldTextWidth=c)),e&&(css(t,{display:"inline-block",verticalAlign:"top"}),e.attr({width:s.width,height:s.height})),b!==this.cTT&&(g=s.fontMetrics(t).b,!defined(r)||e||r===(this.oldRotation||0)&&h===this.oldAlign||css(t,{transform:`rotate(${r}deg)`,transformOrigin:v+`% ${v}px`}),this.getSpanCorrection(!defined(r)&&!this.textWidth&&this.textPxLength||t.offsetWidth,g,getAlignFactor(h)));const{xCorr:w=0,yCorr:T=0}=this,A=(o??x)-w-x-v,E=(n??u)-T-u-v,O={left:x+w+"px",top:u+T+"px",textAlign:h,transformOrigin:A+`px ${E}px`};(a||l)&&(O.transform=`scale(${a??1},${l??1})`),e?(super.updateTransform(),isNumber(x)&&isNumber(u)?(e.attr({x:x+w,y:u+T,width:t.offsetWidth+3,height:t.offsetHeight,"transform-origin":t.getAttribute("transform-origin")||"0 0"}),css(t,{display:d,textAlign:h})):isFirefox&&e.attr({width:0,height:0})):css(t,O),this.cTT=b,this.oldRotation=r,this.oldAlign=h}}add(i){const{foreignObject:t,renderer:e}=this,s=e.box.parentNode,r=[];if(t)t.add(i),super.add(e.createElement("body").attr({xmlns:"http://www.w3.org/1999/xhtml"}).css({background:"transparent",margin:"0 3px 0 0"}).add(t));else{let e;if((this.parentGroup=i)&&!(e=i.div)){let t=i;for(;t;)r.push(t),t=t.parentGroup;for(const i of r.reverse())e=decorateSVGGroup(i,s)}(e||s).appendChild(this.element)}return this.added=!0,this.alignOnAdd&&this.updateTransform(),this}textSetter(t){t!==this.textStr&&(delete this.bBox,delete this.oldTextWidth,AST.setElementHTML(this.element,t??""),this.textStr=t,this.doTransform=!0)}alignSetter(t){this.alignValue=this.textAlign=t,this.doTransform=!0}xSetter(t,e){this[e]=t,this.doTransform=!0}}const proto=HTMLElement.prototype;proto.visibilitySetter=proto.opacitySetter=commonSetter,proto.ySetter=proto.rotationSetter=proto.rotationOriginXSetter=proto.rotationOriginYSetter=proto.xSetter;export default HTMLElement;
"use strict";import U from"../../Core/Utilities.js";const attr=U["attr"];import AccessibilityComponent from"../AccessibilityComponent.js";import KeyboardNavigationHandler from"../KeyboardNavigationHandler.js";import ChartUtilities from"../Utils/ChartUtilities.js";const{getChartTitle,unhideChartElementFromAT}=ChartUtilities;import HTMLUtilities from"../Utils/HTMLUtilities.js";const getFakeMouseEvent=HTMLUtilities["getFakeMouseEvent"];function getExportMenuButtonElement(t){return t.exporting?.svgElements?.[0]}function exportingShouldHaveA11y(t){var e=t.options.exporting,t=getExportMenuButtonElement(t);return!!(e&&!1!==e.enabled&&e.accessibility&&e.accessibility.enabled&&t&&t.element)}class MenuComponent extends AccessibilityComponent{init(){const t=this.chart,e=this;this.addEvent(t,"exportMenuShown",function(){e.onMenuShown()}),this.addEvent(t,"exportMenuHidden",function(){e.onMenuHidden()}),this.createProxyGroup()}onMenuHidden(){const t=this.chart.exporting?.contextMenuEl;t&&t.setAttribute("aria-hidden","true"),this.setExportButtonExpandedState("false")}onMenuShown(){var t=this.chart,e=t.exporting?.contextMenuEl;e&&(this.addAccessibleContextMenuAttribs(),unhideChartElementFromAT(t,e)),this.setExportButtonExpandedState("true")}setExportButtonExpandedState(t){this.exportButtonProxy&&this.exportButtonProxy.innerElement.setAttribute("aria-expanded",t)}onChartRender(){const t=this.chart,e=t.focusElement,n=t.accessibility;this.proxyProvider.clearGroup("chartMenu"),this.proxyMenuButton(),this.exportButtonProxy&&e&&e===t.exporting?.group&&(e.focusBorder?t.setFocusToElement(e,this.exportButtonProxy.innerElement):n&&n.keyboardNavigation.tabindexContainer.focus())}proxyMenuButton(){const t=this.chart,e=this.proxyProvider;var n=getExportMenuButtonElement(t);exportingShouldHaveA11y(t)&&n&&(this.exportButtonProxy=e.addProxyElement("chartMenu",{click:n},"button",{"aria-label":t.langFormat("accessibility.exporting.menuButtonLabel",{chart:t,chartTitle:getChartTitle(t)}),"aria-expanded":!1,title:t.options.lang.contextButtonTitle||null}))}createProxyGroup(){this.chart&&this.proxyProvider&&this.proxyProvider.addGroup("chartMenu")}addAccessibleContextMenuAttribs(){const t=this.chart,e=t.exporting?.divElements;var n;e&&e.length&&(e.forEach(t=>{t&&("LI"!==t.tagName||t.children&&t.children.length?t.setAttribute("aria-hidden","true"):t.setAttribute("tabindex",-1))}),(n=e[0]&&e[0].parentNode)&&attr(n,{"aria-hidden":void 0,"aria-label":t.langFormat("accessibility.exporting.chartMenuLabel",{chart:t}),role:"list"}))}getKeyboardNavigation(){const t=this.keyCodes,n=this.chart,o=this;return new KeyboardNavigationHandler(n,{keyCodeMap:[[[t.left,t.up],function(){return o.onKbdPrevious(this)}],[[t.right,t.down],function(){return o.onKbdNext(this)}],[[t.enter,t.space],function(){return o.onKbdClick(this)}]],validate:function(){return!!n.exporting&&!1!==n.options.exporting?.buttons?.contextButton.enabled&&!1!==n.options.exporting.enabled&&!1!==(n.options.exporting.accessibility?.enabled||!1)},init:function(){var t=o.exportButtonProxy,e=o.chart.exporting?.group;t&&e&&n.setFocusToElement(e,t.innerElement)},terminate:function(){n.hideExportMenu()}})}onKbdPrevious(t){const e=this.chart;var n=e.options.accessibility,o=t.response;let i=e.highlightedExportItemIx||0;for(;i--;)if(e.highlightExportItem(i))return o.success;return n.keyboardNavigation.wrapAround?(e.highlightLastExportItem(),o.success):o.prev}onKbdNext(t){const e=this.chart;var n=e.options.accessibility,o=t.response;for(let t=(e.highlightedExportItemIx||0)+1;t<(e.exporting?.divElements?.length||0);++t)if(e.highlightExportItem(t))return o.success;return n.keyboardNavigation.wrapAround?(e.highlightExportItem(0),o.success):o.next}onKbdClick(t){const e=this.chart;var n=void 0!==e.highlightedExportItemIx&&e.exporting?.divElements?.[e.highlightedExportItemIx],o=getExportMenuButtonElement(e)?.element;return e.exporting?.openMenu?n&&this.fakeClickEvent(n):(o&&this.fakeClickEvent(o),e.highlightExportItem(0)),t.response.success}}!function(){function n(){var t=getExportMenuButtonElement(this);if(t){const e=t.element;e.onclick&&e.onclick(getFakeMouseEvent("click"))}}function o(){const t=this,e=t.exporting?.divElements;e&&t.exporting?.contextMenuEl&&t.exporting?.openMenu&&(e.forEach(t=>{t&&"highcharts-menu-item"===t.className&&t.onmouseout&&t.onmouseout(getFakeMouseEvent("mouseout"))}),t.highlightedExportItemIx=0,t.exporting.contextMenuEl.hideMenu(),t.container.focus())}function i(t){const e=this.exporting?.divElements?.[t],n=void 0!==this.highlightedExportItemIx&&this.exporting?.divElements?.[this.highlightedExportItemIx];var o;return!(!e||"LI"!==e.tagName||e.children&&e.children.length)&&(o=!!(this.renderTo.getElementsByTagName("g")[0]||{}).focus,e.focus&&o&&e.focus(),n&&n.onmouseout&&n.onmouseout(getFakeMouseEvent("mouseout")),e.onmouseover&&e.onmouseover(getFakeMouseEvent("mouseover")),this.highlightedExportItemIx=t,!0)}function r(){if(this.exporting?.divElements){let t=this.exporting?.divElements.length;for(;t--;)if(this.highlightExportItem(t))return!0}return!1}(MenuComponent||(MenuComponent={})).compose=function(t){const e=t.prototype;e.hideExportMenu||(e.hideExportMenu=o,e.highlightExportItem=i,e.highlightLastExportItem=r,e.showExportMenu=n)}}();export default MenuComponent;
"use strict";import BoostableMap from"./BoostableMap.js";import Boostables from"./Boostables.js";import BoostChart from"./BoostChart.js";const{getBoostClipRect,isChartSeriesBoosting}=BoostChart;import D from"../../Core/Defaults.js";const getOptions=D["getOptions"];import H from"../../Core/Globals.js";const{composed,doc,noop,win}=H;import U from"../../Core/Utilities.js";const{addEvent,destroyObjectProperties,error,extend,fireEvent,isArray,isNumber,pick,pushUnique,wrap,defined}=U;import WGLRenderer from"./WGLRenderer.js";import DataTableCore from"../../Data/DataTableCore.js";const CHUNK_SIZE=3e3;let index,mainCanvas;function allocateIfNotSeriesBoosting(t,e){var o=e.boost;t&&o&&o.target&&o.canvas&&!isChartSeriesBoosting(e.chart)&&t.allocateBufferForSingleSeries(e)}function boostEnabled(t){return pick(t&&t.options&&t.options.boost&&t.options.boost.enabled,!0)}function compose(t,o,e,i){if(pushUnique(composed,"Boost.Series")){const r=getOptions().plotOptions,s=t.prototype;if(addEvent(t,"destroy",onSeriesDestroy),addEvent(t,"hide",onSeriesHide),i&&(s.renderCanvas=seriesRenderCanvas),wrap(s,"getExtremes",wrapSeriesGetExtremes),wrap(s,"processData",wrapSeriesProcessData),wrap(s,"searchPoint",wrapSeriesSearchPoint),["translate","generatePoints","drawTracker","drawPoints","render"].forEach(t=>wrapSeriesFunctions(s,o,t)),wrap(e.prototype,"firePointEvent",function(t,e,o){if("click"===e&&this.series.boosted){e=o.point;if((e.dist||e.distX)>=(e.series.options.marker?.radius??10))return}return t.apply(this,[].slice.call(arguments,1))}),Boostables.forEach(t=>{const e=r[t];e&&(e.boostThreshold=5e3,e.boostData=[],o[t].prototype.fillOpacity=!0)}),i){const{area:a,areaspline:n,bubble:l,column:c,heatmap:h,scatter:p,treemap:d}=o;if(a&&extend(a.prototype,{fill:!0,fillOpacity:!0,sampling:!0}),n&&extend(n.prototype,{fill:!0,fillOpacity:!0,sampling:!0}),l){const m=l.prototype;delete m.buildKDTree,wrap(m,"markerAttribs",function(t){return!this.boosted&&t.apply(this,[].slice.call(arguments,1))})}c&&extend(c.prototype,{fill:!0,sampling:!0}),p&&(p.prototype.fill=!0),[h,d].forEach(t=>{t&&wrap(t.prototype,"drawPoints",wrapSeriesDrawPoints)})}}return t}function createAndAttachRenderer(t,e){const o=t.constructor,i=t.seriesGroup||e.group;let r=t.chartWidth,s=t.chartHeight,a=t,n=!1;isChartSeriesBoosting(t)?a=t:(a=e,n=Boolean(e.options.events?.click||e.options.point?.events?.click));const l=a.boost=a.boost||{};if(mainCanvas=mainCanvas||doc.createElement("canvas"),l.target||(l.canvas=mainCanvas,t.renderer.forExport,a.renderTarget=l.target=t.renderer.image("",0,0,r,s).addClass("highcharts-boost-canvas").add(i),l.clear=function(){l.target.attr({href:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="})},l.copy=function(){l.resize(),l.target.attr({href:l.canvas.toDataURL("image/png")})},l.resize=function(){r=t.chartWidth,s=t.chartHeight,(l.targetFo||l.target).attr({x:0,y:0,width:r,height:s}).css({pointerEvents:n?void 0:"none",mixedBlendMode:"normal",opacity:1}).addClass(n?"highcharts-tracker":""),a instanceof o&&a.boost?.markerGroup?.translate(t.plotLeft,t.plotTop)},l.clipRect=t.renderer.clipRect(),(l.targetFo||l.target).attr({zIndex:e.options.zIndex}),a instanceof o&&(a.boost.markerGroup=a.renderer.g().add(i).translate(e.xAxis.pos,e.yAxis.pos))),l.canvas.width=r,l.canvas.height=s,l.clipRect){const c=getBoostClipRect(t,a),h=c.width===t.clipBox.width&&c.height===t.clipBox.height?i:l.targetFo||l.target;l.clipRect.attr(c),h?.clip(l.clipRect)}return l.resize(),l.clear(),l.wgl||(l.wgl=new WGLRenderer(t=>{t.settings.debug.timeBufferCopy&&console.time("buffer copy"),l.copy(),t.settings.debug.timeBufferCopy&&console.timeEnd("buffer copy")}),l.wgl.init(l.canvas)||error("[highcharts boost] - unable to init WebGL renderer"),l.wgl.setOptions(t.options.boost||{}),a instanceof o&&l.wgl.allocateBuffer(t)),l.wgl.setSize(r,s),l.wgl}function destroyGraphics(o){var i=o.points;if(i){let t,e;for(e=0;e<i.length;e+=1)(t=i[e])&&t.destroyElements&&t.destroyElements()}["graph","area","tracker"].forEach(t=>{const e=o[t];e&&(o[t]=e.destroy())});for(const t of o.zones)destroyObjectProperties(t,void 0,!0)}function eachAsync(t,e,o,i,r,s){r=r||0,i=i||CHUNK_SIZE;var a=r+i;let n=!0;for(;n&&r<a&&r<t.length;)n=e(t[r],r),++r;n&&(r<t.length?s?eachAsync(t,e,o,i,r,s):win.requestAnimationFrame?win.requestAnimationFrame(function(){eachAsync(t,e,o,i,r)}):setTimeout(eachAsync,0,t,e,o,i,r):o&&o())}function enterBoost(e){e.boost=e.boost||{getPoint:t=>getPoint(e,t)};const o=e.boost.altered=[];if(["allowDG","directTouch","stickyTracking"].forEach(t=>{o.push({prop:t,val:e[t],own:Object.hasOwnProperty.call(e,t)})}),e.allowDG=!1,e.directTouch=!1,e.stickyTracking=!0,e.finishedAnimating=!0,e.labelBySeries&&(e.labelBySeries=e.labelBySeries.destroy()),e.is("scatter")&&!e.is("treemap")&&e.data.length){for(const t of e.data)t?.destroy?.();e.data.length=0,e.points.length=0,delete e.processedData}}function exitBoost(e){const t=e.boost,o=e.chart,i=o.boost;if(i?.markerGroup){i.markerGroup.destroy(),i.markerGroup=void 0;for(const r of o.series)r.markerGroup=void 0,r.markerGroup=r.plotGroup("markerGroup","markers","visible",1,o.seriesGroup).addClass("highcharts-tracker")}t&&((t.altered||[]).forEach(t=>{t.own?e[t.prop]=t.val:delete e[t.prop]}),t.clear&&t.clear()),(o.seriesGroup||e.group)?.clip()}function hasExtremes(t,e){var o=t.options,i=t.dataTable.modified.rowCount,r=t.xAxis&&t.xAxis.options,s=t.yAxis&&t.yAxis.options,t=t.colorAxis&&t.colorAxis.options;return i>(o.boostThreshold||Number.MAX_VALUE)&&isNumber(s.min)&&isNumber(s.max)&&(!e||isNumber(r.min)&&isNumber(r.max))&&(!t||isNumber(t.min)&&isNumber(t.max))}const getSeriesBoosting=(t,e)=>!t.forceCrop&&(isChartSeriesBoosting(t.chart)||(e?e.length:0)>=(t.options.boostThreshold||Number.MAX_VALUE));function onSeriesDestroy(){const e=this,t=e.chart;t.boost&&t.boost.markerGroup===e.markerGroup&&(e.markerGroup=void 0),t.hoverPoints&&(t.hoverPoints=t.hoverPoints.filter(function(t){return t.series===e})),t.hoverPoint&&t.hoverPoint.series===e&&(t.hoverPoint=void 0)}function onSeriesHide(){const t=this.boost;t&&t.canvas&&t.target&&(t.wgl&&t.wgl.clear(),t.clear&&t.clear())}function renderIfNotSeriesBoosting(t){const e=t.boost;e&&e.canvas&&e.target&&e.wgl&&!isChartSeriesBoosting(t.chart)&&e.wgl.render(t.chart)}function getPoint(t,e){const o=t.options,i=t.xAxis,r=t.pointClass;if(e instanceof r)return e;const s=t.is("scatter"),a=(s&&t.getColumn("x",!0).length?t.getColumn("x",!0):void 0)||(t.getColumn("x").length?t.getColumn("x"):void 0)||o.xData||t.getColumn("x",!0)||!1,n=t.getColumn("y",!0)||o.yData||!1,l=new r(t,s&&a&&n?[a[e.i],n[e.i]]:(isArray(t.options.data)?t.options.data:[])[e.i],a?a[e.i]:void 0);return l.category=pick(i.categories?i.categories[l.x]:l.x,l.x),l.key=l.name??l.category,l.dist=e.dist,l.distX=e.distX,l.plotX=e.plotX,l.plotY=e.plotY,l.index=e.i,l.percentage=e.percentage,l.isInside=t.isPointInside(l),l}function scatterProcessData(t){const e=this,{options:o,xAxis:i,yAxis:r}=e;if(!(e.isDirty||i.isDirty||r.isDirty||t))return!1;e.yAxis.setTickInterval();var t=o.boostThreshold||0,s=o.cropThreshold,a=e.getColumn("x"),n=i.getExtremes(),l=n.max??Number.MAX_VALUE,c=n.min??-Number.MAX_VALUE,h=e.getColumn("y"),p=r.getExtremes(),d=p.max??Number.MAX_VALUE,m=p.min??-Number.MAX_VALUE;if(!e.boosted&&i.old&&r.old&&c>=(i.old.min??-Number.MAX_VALUE)&&l<=(i.old.max??Number.MAX_VALUE)&&m>=(r.old.min??-Number.MAX_VALUE)&&d<=(r.old.max??Number.MAX_VALUE))return e.dataTable.modified.setColumns({x:a,y:h}),!0;var u=e.dataTable.rowCount;if(!t||u<t||s&&!e.forceCrop&&!e.getExtremesFromAll&&!o.getExtremesFromAll&&u<s)return e.dataTable.modified.setColumns({x:a,y:h}),!0;const g=[],f=[],b=[],x=!(isNumber(n.max)||isNumber(n.min)),y=!(isNumber(p.max)||isNumber(p.min));let A=!1,v,C=a[0],w=a[0],E,P=h?.[0],k=h?.[0];for(let t=0,e=a.length;t<e;++t)v=a[t],E=h?.[t],c<=v&&v<=l&&m<=E&&E<=d?(g.push({x:v,y:E}),f.push(v),b.push(E),x&&(C=Math.max(C,v),w=Math.min(w,v)),y&&(P=Math.max(P,E),k=Math.min(k,E))):A=!0;return x&&(i.dataMax=Math.max(C,i.dataMax||0),i.dataMin=Math.min(w,i.dataMin||0)),y&&(r.dataMax=Math.max(P,r.dataMax||0),r.dataMin=Math.min(k,r.dataMin||0)),e.cropped=A,e.cropStart=0,A&&e.dataTable.modified===e.dataTable&&(e.dataTable.modified=new DataTableCore),e.dataTable.modified.setColumns({x:f,y:b}),getSeriesBoosting(e,f)||(e.processedData=g),!0}function seriesRenderCanvas(){const t=this.options||{},h=this.chart,e=h.boost,o=this.boost,p=this.xAxis,d=this.yAxis,i=t.xData||this.getColumn("x",!0),m=t.yData||this.getColumn("y",!0),u=this.getColumn("low",!0),g=this.getColumn("high",!0),r=this.processedData||t.data,s=p.getExtremes(),f=s.min-(p.minPointOffset||0),b=s.max+(p.minPointOffset||0),a=d.getExtremes(),x=a.min-(d.minPointOffset||0),O=a.max+(d.minPointOffset||0),n={},X=!!this.sampling,I=t.enableMouseTracking,L=t.threshold,y=this.pointArrayMap&&"low,high"===this.pointArrayMap.join(","),A=!!t.stacking,l=this.cropStart||0,V=this.requireSorting,v=!i,C="x"===t.findNearestPointBy,c=(this.getColumn("x").length?this.getColumn("x"):void 0)||this.options.xData||this.getColumn("x",!0),w=pick(t.lineWidth,1),j=t.nullInteraction&&x,E=h.tooltip;let P=!1,k,B=d.getThreshold(L),S,G,D,M;if(this.boosted&&(this.points?.forEach(t=>{t?.destroyElements?.()}),this.points=[],E&&!E.isHidden?h.hoverPoint?.series!==this&&!h.hoverPoints?.some(t=>t.series===this)||(h.hoverPoint=h.hoverPoints=void 0,E.hide(0)):h.hoverPoints&&(h.hoverPoints=h.hoverPoints.filter(t=>t.series!==this)),!p.isPanning&&!d.isPanning&&(P=createAndAttachRenderer(h,this),h.boosted=!0,this.visible))){(this.points||this.graph)&&destroyGraphics(this),isChartSeriesBoosting(h)?(this.markerGroup&&this.markerGroup!==e?.markerGroup&&this.markerGroup.destroy(),this.markerGroup=e?.markerGroup,o&&o.target&&(this.renderTarget=o.target=o.target.destroy())):(this.markerGroup===e?.markerGroup&&(this.markerGroup=void 0),this.markerGroup=this.plotGroup("markerGroup","markers","visible",1,h.seriesGroup).addClass("highcharts-tracker"));const N=this.points=[],T=(t,e,o,i)=>{const r=!!c&&c[l+o],s=t=>{h.inverted&&(t=p.len-t,e=d.len-e),N.push({destroy:noop,x:r,clientX:t,plotX:t,plotY:e,i:l+o,percentage:i})};t=Math.ceil(t),index=C?t:t+","+e,I&&(n[index]?r===c[c.length-1]&&(N.length--,s(t)):(n[index]=!0,s(t)))},U=(this.buildKDTree=noop,fireEvent(this,"renderCanvas"),this.is("line")&&1<w&&o?.target&&e&&!e.lineWidthFilter&&(e.lineWidthFilter=h.renderer.definition({tagName:"filter",children:[{tagName:"feMorphology",attributes:{operator:"dilate",radius:.25*w}}],attributes:{id:"linewidth"}}),o.target.attr({filter:"url(#linewidth)"})),P&&(allocateIfNotSeriesBoosting(P,this),P.pushSeries(this),renderIfNotSeriesBoosting(this)),P.settings),R=()=>{fireEvent(this,"renderedCanvas"),delete this.buildKDTree,this.options&&this.buildKDTree(),U.debug.timeKDTree&&console.timeEnd("kd tree building")};h.renderer.forExport||(U.debug.timeKDTree&&console.time("kd tree building"),eachAsync(A?this.data.slice(l):i||r,function(t,e){var o=void 0===h.index;let i,r,s,a,n,l=!1,c=!0;return!defined(t)||(o||(r=v?(i=t[0],t[1]):(i=t,m[e]??j??null),y?(v&&(r=t.slice(1,3)),l=u[e],r=g[e]):A&&(i=t.x,r=t.stackY,l=r-t.y,n=t.percentage),V||(c=(r||0)>=x&&r<=O),null!==r&&i>=f&&i<=b&&c&&(s=p.toPixels(i,!0),X?(void 0!==D&&s!==k||(y||(l=r),(void 0===M||r>G)&&(G=r,M=e),(void 0===D||l<S)&&(S=l,D=e)),C&&s===k||(void 0!==D&&(a=d.toPixels(G,!0),B=d.toPixels(S,!0),T(s,a,M,n),B!==a&&T(s,B,D,n)),D=M=void 0,k=s)):(a=Math.ceil(d.toPixels(r,!0)),T(s,a,e,n)))),!o)},R))}}function wrapSeriesDrawPoints(t){let e=!0;if(!(e=this.chart.options&&this.chart.options.boost?void 0===this.chart.options.boost.enabled||this.chart.options.boost.enabled:e)||!this.boosted)return t.call(this);this.chart.boosted=!0;const o=createAndAttachRenderer(this.chart,this);o&&(allocateIfNotSeriesBoosting(o,this),o.pushSeries(this)),renderIfNotSeriesBoosting(this)}function wrapSeriesFunctions(t,e,o){function i(t){var e=this.options.stacking&&("translate"===o||"generatePoints"===o);this.boosted&&!e&&boostEnabled(this.chart)&&"heatmap"!==this.type&&"treemap"!==this.type&&BoostableMap[this.type]&&0!==this.options.boostThreshold?"render"===o&&this.renderCanvas&&this.renderCanvas():t.call(this)}if(wrap(t,o,i),"translate"===o)for(const r of["column","arearange","columnrange","heatmap","treemap"])e[r]&&wrap(e[r].prototype,o,i)}function wrapSeriesGetExtremes(t){if(this.boosted){if(hasExtremes(this))return{};if(this.xAxis.isPanning||this.yAxis.isPanning)return this}return t.apply(this,[].slice.call(arguments,1))}function wrapSeriesProcessData(t){let e=this.options.data;if(boostEnabled(this.chart)&&BoostableMap[this.type]){var o=this,i=o.is("scatter")&&!o.is("bubble")&&!o.is("treemap")&&!o.is("heatmap");if(!getSeriesBoosting(o,e)||i||o.is("treemap")||o.options.stacking||!hasExtremes(o,!0)){if(o.boosted&&(o.xAxis?.isPanning||o.yAxis?.isPanning))return;i&&"treegrid"!==o.yAxis.type?scatterProcessData.call(o,arguments[1]):t.apply(o,[].slice.call(arguments,1)),e=o.getColumn("x",!0)}o.boosted=getSeriesBoosting(o,e),o.boosted?(o.options.data?.length&&(i=o.getFirstValidPoint(o.options.data),isNumber(i)||isArray(i)||o.is("treemap")||error(12,!1,o.chart)),enterBoost(o)):exitBoost(o)}else t.apply(this,[].slice.call(arguments,1))}function wrapSeriesSearchPoint(t){t=t.apply(this,[].slice.call(arguments,1));return this.boost&&t?this.boost.getPoint(t):t}const BoostSeries={compose:compose,destroyGraphics:destroyGraphics,eachAsync:eachAsync,getPoint:getPoint};export default BoostSeries;
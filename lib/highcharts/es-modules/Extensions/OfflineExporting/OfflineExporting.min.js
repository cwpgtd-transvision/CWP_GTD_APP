"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import Chart from"../../Core/Chart/Chart.js";import D from"../../Core/Defaults.js";const{getOptions,setOptions}=D;import DownloadURL from"../DownloadURL.js";const{downloadURL,getScript}=DownloadURL;import G from"../../Core/Globals.js";const{composed,doc,win}=G;import OfflineExportingDefaults from"./OfflineExportingDefaults.js";import U from"../../Core/Utilities.js";const{addEvent,extend,pushUnique}=U;var OfflineExporting;!function(t){t.compose=function(t){if(addEvent(t,"downloadSVG",async function(t){const{svg:e,exportingOptions:o,exporting:n,preventDefault:i}=t;if("application/pdf"===o?.type){i?.();try{var{type:r,filename:a,scale:l,libURL:s}=G.Exporting.prepareImageOptions(o);if("application/pdf"===r){win.jspdf?.jsPDF||(await getScript(s+"jspdf.js"),await getScript(s+"svg2pdf.js"));var f=e,p=l,c=a,d=o?.pdfFont;if(f=function(t,e){const r=doc.createElement("div"),o=(AST.setElementHTML(r,t),r.getElementsByTagName("text"));let n,a;return[].forEach.call(o,function(i){for(["fontFamily","fontSize"].forEach(t=>{{var o=i,n=t;let e=o;for(;e&&e!==r;){if(e.style[n]){let t=e.style[n];"fontSize"===n&&/em$/.test(t)&&(t=Math.round(16*parseFloat(t))+"px"),o.style[n]=t;break}e=e.parentNode}return}}),i.style.fontFamily=e?.normal?"HighchartsFont":String(i.style.fontFamily&&i.style.fontFamily.split(" ").splice(-1)),n=i.getElementsByTagName("title"),[].forEach.call(n,function(t){i.removeChild(t)}),a=i.getElementsByClassName("highcharts-text-outline");0<a.length;){const t=a[0];t.parentNode&&t.parentNode.removeChild(t)}}),r.querySelector("svg")}(f,d)){{{var u=f;var h=d;var g=(t,e)=>{win.jspdf.jsPDF.API.events.push(["initialized",function(){this.addFileToVFS(t,e),this.addFont(t,"HighchartsFont",t),this.getFontList()?.HighchartsFont||this.setFont("HighchartsFont")}])};h&&!/[^\u0000-\u007F\u200B]+/.test(u.textContent||"")&&(h=void 0);let t;for(const y of["normal","italic","bold","bolditalic"]){var m=h?.[y];if(m)try{const v=await win.fetch(m);if(!v.ok)throw new Error("Failed to fetch font: "+m);const x=await v.blob(),E=new FileReader;var w=await new Promise((t,e)=>{E.onloadend=()=>{"string"==typeof E.result?t(E.result.split(",")[1]):e(new Error("Failed to read font as base64"))},E.onerror=e,E.readAsDataURL(x)});g(y,w),"normal"===y&&(t=w)}catch(t){}else t&&g(y,t)}}await 0}d=await async function(t,e,o){const n=(Number(t.getAttribute("width"))+2*e)*o,i=(Number(t.getAttribute("height"))+2*e)*o,r=new win.jspdf.jsPDF(n<i?"p":"l","pt",[n,i]),a=([].forEach.call(t.querySelectorAll('*[visibility="hidden"]'),function(t){t.parentNode.removeChild(t)}),t.querySelectorAll("linearGradient"));for(let e=0;e<a.length;e++){const l=a[e],s=l.querySelectorAll("stop");let t=0;for(;t<s.length&&"0"===s[t].getAttribute("offset")&&"0"===s[t+1].getAttribute("offset");)s[t].remove(),t++}return[].forEach.call(t.querySelectorAll("tspan"),t=>{"â€‹"===t.textContent&&(t.textContent=" ",t.setAttribute("dx",-5))}),await r.svg(t,{x:0,y:0,width:n,height:i,removeInvalid:!0}),r.output("datauristring")}(f,0,p),downloadURL(d,c)}await 0}}catch(t){await n?.fallbackToServer(o,t)}}}),pushUnique(composed,"OfflineExporting")){extend(Chart.prototype,{exportChartLocal:async function(t,e){await this.exporting?.exportChart(t,e)}}),setOptions(OfflineExportingDefaults);const e=getOptions().exporting?.buttons?.contextButton?.menuItems;e&&e.push("downloadPDF")}},t.downloadSVGLocal=async function(t,e){await G.Exporting.prototype.downloadSVG.call(void 0,t,e)}}(OfflineExporting=OfflineExporting||{});export default OfflineExporting;
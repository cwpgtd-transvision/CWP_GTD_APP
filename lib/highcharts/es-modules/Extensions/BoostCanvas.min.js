"use strict";import BoostChart from"./Boost/BoostChart.js";const{getBoostClipRect,isChartSeriesBoosting}=BoostChart;import BoostSeries from"./Boost/BoostSeries.js";const destroyGraphics=BoostSeries["destroyGraphics"];import Color from"../Core/Color/Color.js";const color=Color["parse"];import H from"../Core/Globals.js";const{doc,noop}=H;import U from"../Core/Utilities.js";const{addEvent,fireEvent,isNumber,merge,pick,wrap}=U;var BoostCanvas;!function(t){const v="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",$=5e4;let p,tt;function d(t,o,e,i,r){r&&o!==r.clientX&&(t.moveTo(r.clientX,r.yBottom),t.lineTo(r.clientX,r.plotY),t.lineTo(o,e),t.lineTo(o,i))}function g(t,o,e,i,r){t.moveTo(o,e),t.arc(o,e,this.radii&&this.radii[r],0,2*Math.PI,!1)}function u(t,o,e,i){t.rect(o-1,e,1,i-e)}function m(){this.boost&&this.boost.copy&&this.boost.copy()}function f(){const t=this.boost||{};t.target&&t.target.attr({href:v}),t.canvas&&t.canvas.getContext("2d").clearRect(0,0,t.canvas.width,t.canvas.height)}function y(){isChartSeriesBoosting(this.chart)?this.boost&&this.boost.clear&&this.boost.clear():this.boost&&this.boost.copy?this.boost.copy():this.chart.boost&&this.chart.boost.copy&&this.chart.boost.copy()}function b(t,o,e){t.lineTo(o,e)}function C(){function o(t,o,e,i,r,s,n){t.call(this,e,o,i,r,s,n)}const t=this.chart,e=isChartSeriesBoosting(t)?t:this,i=e===t?t.seriesGroup:t.seriesGroup||this.group,r=t.chartWidth,s=t.chartHeight;let n;const a=e.boost=e.boost||{};return n=a.targetCtx,a.canvas?(e,p):(a.canvas=doc.createElement("canvas"),a.target=t.renderer.image("",0,0,r,s).addClass("highcharts-boost-canvas").add(i),n=a.targetCtx=a.canvas.getContext("2d"),t.inverted&&["moveTo","lineTo","rect","arc"].forEach(t=>{wrap(n,t,o)}),a.copy=function(){a.target.attr({href:a.canvas.toDataURL("image/png")})},a.clear=function(){n.clearRect(0,0,a.canvas.width,a.canvas.height),e===a.target&&a.target.attr({href:v})},a.clipRect=t.renderer.clipRect(),a.target.clip(a.clipRect)),a.canvas.width!==r&&(a.canvas.width=r),a.canvas.height!==s&&(a.canvas.height=s),a.target.attr({x:0,y:0,width:r,height:s,style:"pointer-events: none",href:v}),a.clipRect&&a.clipRect.attr(getBoostClipRect(t,e)),n}function A(){const A=this,t=A.options,x=A.chart,S=A.xAxis,B=A.yAxis,o=x.options.boost||{},e={timeRendering:o.timeRendering||!1,timeSeriesProcessing:o.timeSeriesProcessing||!1,timeSetup:o.timeSetup||!1},i=A.getColumn("x",!0),w=A.getColumn("y",!0),n=t.data,r=S.getExtremes(),T=r.min,k=r.max,s=B.getExtremes(),R=s.min,E=s.max,a={},K=!!A.sampling,c=t.marker&&t.marker.radius,W=A.cvsStrokeBatch||1e3,q=t.enableMouseTracking,l=t.threshold,M=isNumber(l),N=B.getThreshold(l),Q=A.fill,G=A.pointArrayMap&&"low,high"===A.pointArrayMap.join(","),P=!!t.stacking,h=A.cropStart||0,p=x.options.loading,z=A.requireSorting,J=t.connectNulls,D=!i,Y=P?A.data:i||n,_=A.fillOpacity?Color.parse(A.color).setOpacity(pick(t.fillOpacity,.75)).get():A.color,F="x"===t.findNearestPointBy,d=this.boost||{},g=A.cvsDrawPoint,L=t.lineWidth?A.cvsLineTo:void 0,j=c&&c<=1?A.cvsMarkerSquare:A.cvsMarkerCircle,Z=(d.target&&d.target.attr({href:v}),(A.points||A.graph)&&destroyGraphics(A),A.plotGroup("group","series",A.visible?"visible":"hidden",t.zIndex,x.seriesGroup),A.markerGroup=A.group,addEvent(A,"destroy",function(){A.markerGroup=null}),this.points=[]),O=this.getContext();if(A.buildKDTree=noop,d.clear&&d.clear(),A.visible){99999<n.length&&(x.options.loading=merge(p,{labelStyle:{backgroundColor:color("#ffffff").setOpacity(.75).get(),padding:"1em",borderRadius:"0.5em"},style:{backgroundColor:"none",opacity:1}}),U.clearTimeout(tt),x.showLoading("Drawing..."),x.options.loading=p),e.timeRendering&&console.time("canvas rendering");let r=0,v,s,u=N,m,f,y,b,C,i;const V=function(){Q?(O.fillStyle=_,O.fill()):(O.strokeStyle=A.color,O.lineWidth=t.lineWidth,O.stroke())},X=function(t,o,e,i){0===r&&(O.beginPath(),L&&(O.lineJoin="round")),x.scroller&&"highcharts-navigator-series"===A.options.className?(o+=x.scroller.top,e&&(e+=x.scroller.top)):o+=x.plotTop,t+=x.plotLeft,m?O.moveTo(t,o):g?g(O,t,o,e,s):L?L(O,t,o):j&&j.call(A,O,t,o,c,i),(r+=1)===W&&(V(),r=0),s={clientX:t,plotY:o,yBottom:e}},H=(this.getColumn("x").length?this.getColumn("x"):void 0)||this.options.xData||!!this.getColumn("x",!0).length&&this.getColumn("x",!0),I=function(t,o,e){i=F?t:t+","+o,q&&!a[i]&&(a[i]=!0,x.inverted&&(t=S.len-t,o=B.len-o),Z.push({x:!!H&&H[h+e],clientX:t,plotX:t,plotY:o,i:h+e}))};BoostSeries.eachAsync(Y,(t,o)=>{var e=void 0===x.index;let i,r,s,n,a,c,l=!1,h=!1,p=NaN,d=NaN,g=!0;return e||(D?(i=t[0],r=t[1],Y[o+1]&&(p=Y[o+1][0]),Y[o-1]&&(d=Y[o-1][0])):(i=t,r=w[o],Y[o+1]&&(p=Y[o+1]),Y[o-1]&&(d=Y[o-1])),p&&p>=T&&p<=k&&(l=!0),d&&d>=T&&d<=k&&(h=!0),G?(D&&(r=t.slice(1,3)),c=r[0],r=r[1]):P&&(i=t.x,r=t.stackY,c=r-t.y),a=null===r,z||(g=r>=R&&r<=E),!a&&(i>=T&&i<=k&&g||l||h)&&(s=Math.round(S.toPixels(i,!0)),K?(void 0!==b&&s!==v||(G||(c=r),(void 0===C||r>y)&&(y=r,C=o),(void 0===b||c<f)&&(f=c,b=o)),s!==v&&(void 0!==b&&(n=B.toPixels(y,!0),u=B.toPixels(f,!0),X(s,M?Math.min(n,N):n,M?Math.max(u,N):u,o),I(s,n,C),u!==n&&I(s,u,b)),b=C=void 0,v=s)):(n=Math.round(B.toPixels(r,!0)),X(s,n,u,o),I(s,n,o))),m=a&&!J,o%$==0&&(A.boost&&A.boost.copy?A.boost.copy():A.chart.boost&&A.chart.boost.copy&&A.chart.boost.copy())),!e},function(){const t=x.loadingDiv,o=x.loadingShown;V(),A.canvasToSVG(),e.timeRendering&&console.timeEnd("canvas rendering"),fireEvent(A,"renderedCanvas"),o&&(t.style.transition="opacity 250ms",t.opacity=0,x.loadingShown=!1,tt=setTimeout(function(){t.parentNode&&t.parentNode.removeChild(t),x.loadingDiv=x.loadingSpan=null},250)),delete A.buildKDTree,A.buildKDTree()},x.renderer.forExport?Number.MAX_VALUE:void 0)}}function x(t,o,e,i){t.moveTo(o,e),t.arc(o,e,i,0,2*Math.PI,!1)}function S(t,o,e,i){t.rect(o-i,e-i,2*i,2*i)}function B(){const n=this.chart,a=this.getContext(),c=this.chart.inverted,l=this.xAxis,h=this.yAxis;a?(this.points.forEach(t=>{var o,e,i,r=t.plotY;let s;void 0!==r&&!isNaN(r)&&null!==t.y&&a&&({x:r=0,y:o=0,width:e=0,height:i=0}=t.shapeArgs||{},s=n.styledMode?t.series.colorAttribs(t):t.series.pointAttribs(t),a.fillStyle=s.fill,c?a.fillRect(h.len-o+l.left,l.len-r+h.top,-i,-e):a.fillRect(r+l.left,o+h.top,e,i))}),this.canvasToSVG()):this.chart.showLoading("Your browser doesn't support HTML5 canvas, <br>please use a modern browser")}t.compose=function(t,o,e){const i=o.prototype;if(!i.renderCanvas){var{area:o,bubble:e,column:r,heatmap:s,scatter:n}=e;if((p=t).prototype.callbacks.push(t=>{addEvent(t,"predraw",f),addEvent(t,"render",m)}),i.canvasToSVG=y,i.cvsLineTo=b,i.getContext=C,i.renderCanvas=A,o){const a=o.prototype;a.cvsDrawPoint=d,a.fill=!0,a.fillOpacity=!0,a.sampling=!0}if(e){const c=e.prototype;c.cvsMarkerCircle=g,c.cvsStrokeBatch=1}if(r){const l=r.prototype;l.cvsDrawPoint=u,l.fill=!0,l.sampling=!0}if(s&&(t=s.prototype,wrap(t,"drawPoints",B)),n){const h=n.prototype;h.cvsMarkerCircle=x,h.cvsMarkerSquare=S,h.fill=!0}}}}(BoostCanvas=BoostCanvas||{});export default BoostCanvas;
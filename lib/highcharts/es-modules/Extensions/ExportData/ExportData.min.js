"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import Chart from"../../Core/Chart/Chart.js";import D from"../../Core/Defaults.js";const{getOptions,setOptions}=D;import DownloadURL from"../DownloadURL.js";const downloadURL=DownloadURL["downloadURL"];import ExportDataDefaults from"./ExportDataDefaults.js";import G from"../../Core/Globals.js";const{composed,doc,win}=G;import U from"../../Core/Utilities.js";const{addEvent,defined,extend,find,fireEvent,isNumber,pick,pushUnique}=U;var ExportData;!function(){function h(){this.wrapLoading(()=>{var t=this.getCSV(!0);downloadURL(e(t,"text/csv")||"data:text/csv,\ufeff"+encodeURIComponent(t),this.getFilename()+".csv")})}function d(){this.wrapLoading(()=>{var t='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head>\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Ark1</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e<style>td{border:none;font-family: Calibri, sans-serif;} .number{mso-number-format:"0.00";} .text{ mso-number-format:"@";}</style><meta name=ProgId content=Excel.Sheet><meta charset=UTF-8></head><body>'+this.getTable(!0)+"</body></html>";downloadURL(e(t,"application/vnd.ms-excel")||"data:application/vnd.ms-excel;base64,"+(t=t,win.btoa(unescape(encodeURIComponent(t)))),this.getFilename()+".xls")})}function e(t,e){const o=win.navigator,a=win.URL||win.webkitURL||win;try{if(o.msSaveOrOpenBlob&&win.MSBlobBuilder){const n=new win.MSBlobBuilder;return n.append(t),n.getBlob("image/svg+xml")}return a.createObjectURL(new win.Blob(["\ufeff"+t],{type:e}))}catch(t){}}function u(t){let n="";const i=this.getDataRows(),e=this.options?.csv,r=pick(e?.decimalPoint,","!==e?.itemDelimiter&&t?1.1.toLocaleString()[1]:"."),s=pick(e?.itemDelimiter,","===r?";":","),l=e?.lineDelimiter;return i.forEach((t,e)=>{let o="",a=t.length;for(;a--;)"number"==typeof(o="string"==typeof(o=t[a])?`"${o}"`:o)&&"."!==r&&(o=o.toString().replace(".",r)),t[a]=o;t.length=i.length?i[0].length:0,n+=t.join(s),e<i.length-1&&(n+=l)}),n}function g(n){function i(t,e,o){if(D.columnHeaderFormatter){var a=D.columnHeaderFormatter(t,e,o);if(!1!==a)return a}return!t&&l?l:!t.bindAxes&&c&&l?t.options.title&&t.options.title.text||(t.dateTime?c:l):n?{columnTitle:(1<(o||0)?e:t.name)||"",topLevelColumnTitle:t.name}:t.name+(1<(o||0)?" ("+e+")":"")}function x(o,t,a){const n={},i={};return t.forEach(function(t){var e=(o.keyToAxis&&o.keyToAxis[t]||t)+"Axis",e=isNumber(a)?o.chart[e][a]:o[e];n[t]=e&&e.categories||[],i[t]=e&&e.dateTime}),{categoryMap:n,dateTimeValueAxisMap:i}}const t=this.chart,b=t.hasParallelCoordinates,T=t.time,D=this.options?.csv||{},r=t.xAxis,y={},e=[],s=[],w=[],o=t.options.lang,a=o.exportData,l=a?.categoryHeader,c=a?.categoryDatetimeHeader,v=[];let p,h,E,S=0,d,u;for(d in t.series.forEach(function(l){const t=l.options.keys,c=l.xAxis,p=t||(o=c,a=(e=l).pointArrayMap||["y"],e.data.some(t=>void 0!==t.y&&t.name)&&o&&!o.categories&&"name"!==e.exportKey?["x",...a]:a),h=p.length,d=!l.requireSorting&&{},u=r.indexOf(c);var e,o,a;let g=x(l,p),f,m;if(!1!==l.options.includeInDataExport&&!l.options.isInternal&&!1!==l.visible){for(find(v,function(t){return t[0]===u})||v.push([u,S]),m=0;m<h;)E=i(l,p[m],p.length),w.push(E.columnTitle||E),n&&s.push(E.topLevelColumnTitle||E),m++;f={chart:l.chart,autoIncrement:l.autoIncrement,options:l.options,pointArrayMap:l.pointArrayMap,index:l.index},l.options.data?.forEach(function(t,e){var o={series:f};let a,n,i;b&&(g=x(l,p,e)),l.pointClass.prototype.applyOptions.apply(o,[t]);t=l.data[e]&&l.data[e].name;if(a=(o.x??"")+","+t,m=0,(!c||"name"===l.exportKey||!b&&c&&c.hasNames&&t)&&(a=t),d&&(d[a]&&(a+="|"+e),d[a]=!0),y[a]){var e=a+","+y[a].pointers[l.index],r=a;y[a].pointers[l.index]&&(y[e]||(y[e]=[],y[e].xValues=[],y[e].pointers=[]),a=e),y[r].pointers[l.index]+=1}else{y[a]=[],y[a].xValues=[];const s=[];for(let t=0;t<l.chart.series.length;t++)s[t]=0;y[a].pointers=s,y[a].pointers[l.index]=1}for(y[a].x=o.x,y[a].name=t,y[a].xValues[u]=o.x;m<h;)n=p[m],i=l.pointClass.prototype.getNestedProperty.apply(o,[n]),y[a][S+m]=pick(g.categoryMap[n][i],g.dateTimeValueAxisMap[n]?T.dateFormat(D.dateFormat,i):null,i),m++}),S+=m}}),y)Object.hasOwnProperty.call(y,d)&&e.push(y[d]);let g,f;for(h=n?[s,w]:[w],S=v.length;S--;)g=v[S][0],f=v[S][1],p=r[g],e.sort(function(t,e){return t.xValues[g]-e.xValues[g]}),u=i(p),h[0].splice(f,0,u),n&&h[1]&&h[1].splice(f,0,u),e.forEach(function(t){let e=t.name;p&&!defined(e)&&(e=p.dateTime?(t.x instanceof Date&&(t.x=t.x.getTime()),T.dateFormat(D.dateFormat,t.x)):p.categories?pick(p.names[t.x],p.categories[t.x],t.x):t.x),t.splice(f,0,e)});return h=h.concat(e),fireEvent(t,"exportData",{dataRows:h}),h}function f(t){const e=t=>{if(!t.tagName||"#text"===t.tagName)return t.textContent||"";const o=t.attributes;let a="<"+t.tagName;return o&&Object.keys(o).forEach(t=>{var e=o[t];a+=` ${t}="${e}"`}),a=(a+=">")+(t.textContent||""),(t.children||[]).forEach(t=>{a+=e(t)}),a+=`</${t.tagName}>`};t=this.getTableAST(t);return e(t)}function m(t){let a=0;const e=[],d=this,o=d.chart,n=o.options,r=t?1.1.toLocaleString()[1]:".",u=pick(d.options.useMultiLevelHeaders,!0),i=d.getDataRows(u),s=u?i.shift():null,l=i.shift(),g=function(t,e){let o=t.length;if(e.length!==o)return!1;for(;o--;)if(t[o]!==e[o])return!1;return!0},f=function(t,e,o,a){let n=pick(a,""),i="highcharts-text"+(e?" "+e:"");return"number"==typeof n?(n=n.toString(),","===r&&(n=n.replace(".",r)),i="highcharts-number"):a||(i="highcharts-empty"),{tagName:t,attributes:o=extend({class:i},o),textContent:n}};t=(d.options||{}).tableCaption;!1!==t&&e.push({tagName:"caption",attributes:{class:"highcharts-table-caption"},textContent:"string"==typeof t?t:n.title?.text||n.lang.chartTitle});for(let t=0,e=i.length;t<e;++t)i[t].length>a&&(a=i[t].length);e.push(function(t,e,o){const a=[];let n=0,i=o||e&&e.length,r,s=0,l;if(u&&t&&e&&!g(t,e)){const c=[];for(;n<i;++n)if((r=t[n])===t[n+1])++s;else if(s)c.push(f("th","highcharts-table-topheading",{scope:"col",colspan:s+1},r)),s=0;else{r===e[n]?d.options.useRowspanHeaders?(l=2,delete e[n]):(l=1,e[n]=""):l=1;const p=f("th","highcharts-table-topheading",{scope:"col"},r);1<l&&p.attributes&&(p.attributes.valign="top",p.attributes.rowspan=l),c.push(p)}a.push({tagName:"tr",children:c})}if(e){const h=[];for(n=0,i=e.length;n<i;++n)void 0!==e[n]&&h.push(f("th",null,{scope:"col"},e[n]));a.push({tagName:"tr",children:h})}return{tagName:"thead",children:a}}(s,l||[],Math.max(a,l?.length||0)));const c=[];i.forEach(function(e){const o=[];for(let t=0;t<a;t++)o.push(f(t?"td":"th",null,t?{}:{scope:"row"},e[t]));c.push({tagName:"tr",children:o})}),e.push({tagName:"tbody",children:c});t={tree:{tagName:"table",id:"highcharts-data-table-"+o.index,children:e}};return fireEvent(o,"afterGetTableAST",t),t.tree}function x(){this.toggleDataTable(!1)}function b(t){const e=this.chart,o=(t=pick(t,!this.isDataTableVisible))&&!this.dataTableDiv;if(o&&(this.dataTableDiv=doc.createElement("div"),this.dataTableDiv.className="highcharts-data-table",e.renderTo.parentNode.insertBefore(this.dataTableDiv,e.renderTo.nextSibling)),this.dataTableDiv){const s=this.dataTableDiv.style,l=s.display;if(s.display=t?"block":"none",t){this.dataTableDiv.innerHTML=AST.emptyHTML;const c=new AST([this.getTableAST()]);c.addToDOM(this.dataTableDiv),fireEvent(e,"afterViewData",{element:this.dataTableDiv,wasHidden:o||l!==s.display})}else fireEvent(e,"afterHideData")}this.isDataTableVisible=t;const a=this.divElements,n=this.options,i=n.buttons?.contextButton.menuItems,r=e.options.lang;n&&n.menuItemDefinitions&&r&&r.viewData&&r.hideData&&i&&a&&((t=a[i.indexOf("viewData")])&&AST.setElementHTML(t,this.isDataTableVisible?r.hideData:r.viewData))}function T(){this.toggleDataTable(!0)}function D(t){const e=this.chart,o=Boolean(this.options.showExportInProgress),a=win.requestAnimationFrame||setTimeout;a(()=>{o&&e.showLoading(e.options.lang.exportInProgress),a(()=>{try{t.call(this)}finally{o&&e.hideLoading()}})})}function y(){const n=this.exporting,i=n?.dataTableDiv,r=(t,e)=>t.children[e].textContent,s=(a,n)=>(t,e)=>{var o;return o=r(n?t:e,a),e=r(n?e:t,a),""===o||""===e||isNaN(o)||isNaN(e)?o.toString().localeCompare(e):o-e};if(i&&n.options.allowTableSorting){const t=i.querySelector("thead tr");t&&t.childNodes.forEach(o=>{const a=i.querySelector("tbody");o.addEventListener("click",function(){const t=[...i.querySelectorAll("tr:not(thead tr)")],e=[...o.parentNode.children];n&&(t.sort(s(e.indexOf(o),n.ascendingOrderInTable=!n.ascendingOrderInTable)).forEach(t=>{a?.appendChild(t)}),e.forEach(e=>{["highcharts-sort-ascending","highcharts-sort-descending"].forEach(t=>{e.classList.contains(t)&&e.classList.remove(t)})}),o.classList.add(n.ascendingOrderInTable?"highcharts-sort-ascending":"highcharts-sort-descending"))})})}}function w(){this.options?.exporting?.showTable&&!this.options.chart.forExport&&this.exporting?.viewData()}function v(){this.exporting?.dataTableDiv?.remove()}(ExportData||(ExportData={})).compose=function(t,e,o){if(pushUnique(composed,"ExportData")){extend(Chart.prototype,{downloadCSV:function(){return this.exporting?.downloadCSV()},downloadXLS:function(){return this.exporting?.downloadXLS()},getCSV:function(t){return this.exporting?.getCSV(t)},getDataRows:function(t){return this.exporting?.getDataRows(t)},getTable:function(t){return this.exporting?.getTable(t)},getTableAST:function(t){return this.exporting?.getTableAST(t)},hideData:function(){return this.exporting?.hideData()},toggleDataTable:function(t){return this.exporting?.toggleDataTable(t)},viewData:function(){return this.exporting?.viewData()}});const a=e.prototype;if(!a.downloadCSV){addEvent(t,"afterViewData",y),addEvent(t,"render",w),addEvent(t,"destroy",v),a.downloadCSV=h,a.downloadXLS=d,a.getCSV=u,a.getDataRows=g,a.getTable=f,a.getTableAST=m,a.hideData=x,a.toggleDataTable=b,a.wrapLoading=D,a.viewData=T,setOptions(ExportDataDefaults);const n=getOptions().exporting?.buttons?.contextButton?.menuItems,{arearange:i,gantt:r,map:s,mapbubble:l,treemap:c,xrange:p}=(n&&n.push("separator","downloadCSV","downloadXLS","viewData"),o.types);i&&(i.prototype.keyToAxis={low:"y",high:"y"}),r&&(r.prototype.exportKey="name",r.prototype.keyToAxis={start:"x",end:"x"}),s&&(s.prototype.exportKey="name"),l&&(l.prototype.exportKey="name"),c&&(c.prototype.exportKey="name"),p&&(p.prototype.keyToAxis={x2:"x"})}}}}();export default ExportData;
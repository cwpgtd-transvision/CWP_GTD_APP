"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import Chart from"../../Core/Chart/Chart.js";import ChartNavigationComposition from"../../Core/Chart/ChartNavigationComposition.js";import D from"../../Core/Defaults.js";const{defaultOptions,setOptions}=D;import DownloadURL from"../DownloadURL.js";const{downloadURL,getScript}=DownloadURL;import ExportingDefaults from"./ExportingDefaults.js";import ExportingSymbols from"./ExportingSymbols.js";import Fullscreen from"./Fullscreen.js";import G from"../../Core/Globals.js";const{composed,doc,isFirefox,isMS,isSafari,SVG_NS,win}=G;import HU from"../../Core/HttpUtilities.js";import U from"../../Core/Utilities.js";const{addEvent,clearTimeout,createElement,css,discardElement,error,extend,find,fireEvent,isObject,merge,objectEach,pick,pushUnique,removeEvent,splat,uniqueKey}=U,domurl=(AST.allowedAttributes.push("data-z-index","fill-opacity","filter","preserveAspectRatio","rx","ry","stroke-dasharray","stroke-linejoin","stroke-opacity","text-anchor","transform","transform-origin","version","viewBox","visibility","xmlns","xmlns:xlink"),AST.allowedTags.push("desc","clippath","fedropshadow","femorphology","g","image"),win.URL||win.webkitURL||win);class Exporting{constructor(e,t){this.options={},this.chart=e,this.options=t,this.btnCount=0,this.buttonOffset=0,this.divElements=[],this.svgElements=[]}static hyphenate(e){return e.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()})}static async imageToDataURL(e,t,i){const o=await Exporting.loadImage(e),n=doc.createElement("canvas"),r=n?.getContext("2d");if(r)return n.height=o.height*t,n.width=o.width*t,r.drawImage(o,0,0,n.width,n.height),n.toDataURL(i);throw new Error("No canvas found!")}static loadImage(o){return new Promise((e,t)=>{const i=new win.Image;i.crossOrigin="Anonymous",i.onload=()=>{setTimeout(()=>{e(i)},Exporting.loadEventDeferDelay)},i.onerror=e=>{t(e)},i.src=o})}static prepareImageOptions(e){const t=e?.type||"image/png",i=e?.libURL||defaultOptions.exporting?.libURL;return{type:t,filename:(e?.filename||"chart")+"."+("image/svg+xml"===t?"svg":t.split("/")[1]),scale:e?.scale||1,libURL:"/"!==i?.slice(-1)?i+"/":i}}static sanitizeSVG(e,t){var i=e.indexOf("</svg>")+6,o=-1<e.indexOf("<foreignObject");let n=e.substr(i);return e=e.substr(0,i),o?e=e.replace(/(<(?:img|br).*?(?=\>))>/g,"$1 />"):n&&t?.exporting?.allowHTML&&(n='<foreignObject x="0" y="0" width="'+t.chart.width+'" height="'+t.chart.height+'"><body xmlns="http://www.w3.org/1999/xhtml">'+n.replace(/(<(?:img|br).*?(?=\>))>/g,"$1 />")+"</body></foreignObject>",e=e.replace("</svg>",n+"</svg>")),e=e.replace(/zIndex="[^"]+"/g,"").replace(/symbolName="[^"]+"/g,"").replace(/jQuery\d+="[^"]+"/g,"").replace(/url\(("|&quot;)(.*?)("|&quot;)\;?\)/g,"url($2)").replace(/url\([^#]+#/g,"url(#").replace(/<svg /,'<svg xmlns:xlink="http://www.w3.org/1999/xlink" ').replace(/ (NS\d+\:)?href=/g," xlink:href=").replace(/\n+/g," ").replace(/&nbsp;/g," ").replace(/&shy;/g,"­")}static svgToDataURL(e){const t=win.navigator.userAgent;var i=-1<t.indexOf("WebKit")&&t.indexOf("Chrome")<0;try{if(!i&&-1===e.indexOf("<foreignObject"))return domurl.createObjectURL(new win.Blob([e],{type:"image/svg+xml;charset-utf-16"}))}catch{}return"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(e)}addButton(e){const t=this,i=t.chart,o=i.renderer,n=merge(i.options.navigation?.buttonOptions,e),r=n.onclick,s=n.menuItems,a=n.symbolSize||12;let l;if(!1===n.enabled||!n.theme)return;const c=i.styledMode?{}:n.theme;let p=()=>{};r?p=function(e){e&&e.stopPropagation(),r.call(i,e)}:s&&(p=function(e){e&&e.stopPropagation(),t.contextMenu(d.menuClassName,s,d.translateX||0,d.translateY||0,d.width||0,d.height||0,d),d.setState(2)}),n.text&&n.symbol?c.paddingLeft=pick(c.paddingLeft,30):n.text||extend(c,{width:n.width,height:n.height,padding:0});const d=o.button(n.text||"",0,0,p,c,void 0,void 0,void 0,void 0,n.useHTML).addClass(e.className||"").attr({title:pick(i.options.lang[n._titleKey||n.titleKey],"")});d.menuClassName=e.menuClassName||"highcharts-menu-"+t.btnCount++,n.symbol&&(l=o.symbol(n.symbol,Math.round((n.symbolX||0)-a/2),Math.round((n.symbolY||0)-a/2),a,a,{width:a,height:a}).addClass("highcharts-button-symbol").attr({zIndex:1}).add(d),i.styledMode||l.attr({stroke:n.symbolStroke,fill:n.symbolFill,"stroke-width":n.symbolStrokeWidth||1})),d.add(t.group).align(extend(n,{width:d.width,x:pick(n.x,t.buttonOffset)}),!0,"spacingBox"),t.buttonOffset+=((d.width||0)+(n.buttonSpacing||0))*("right"===n.align?-1:1),t.svgElements.push(d,l)}afterPrint(){const e=this.chart;if(this.printReverseInfo){const{childNodes:t,origDisplay:i,resetParams:o}=this.printReverseInfo;this.moveContainers(e.renderTo),[].forEach.call(t,function(e,t){1===e.nodeType&&(e.style.display=i[t]||"")}),this.isPrinting=!1,o&&e.setSize.apply(e,o),delete this.printReverseInfo,Exporting.printingChart=void 0,fireEvent(e,"afterPrint")}}beforePrint(){const e=this.chart,t=doc.body,i=this.options.printMaxWidth,o={childNodes:t.childNodes,origDisplay:[],resetParams:void 0};this.isPrinting=!0,e.pointer?.reset(void 0,0),fireEvent(e,"beforePrint"),i&&e.chartWidth>i&&(o.resetParams=[e.options.chart.width,void 0,!1],e.setSize(i,void 0,!1)),[].forEach.call(o.childNodes,function(e,t){1===e.nodeType&&(o.origDisplay[t]=e.style.display,e.style.display="none")}),this.moveContainers(t),this.printReverseInfo=o}contextMenu(t,e,i,o,n,r,s){const a=this,l=a.chart,c=l.options.navigation,p=l.chartWidth,d=l.chartHeight,h="cache-"+t,g=Math.max(n,r);let m,u=l[h];u||(a.contextMenuEl=l[h]=u=createElement("div",{className:t},{position:"absolute",zIndex:1e3,padding:g+"px",pointerEvents:"auto",...l.renderer.style},l.scrollablePlotArea?.fixedDiv||l.container),m=createElement("ul",{className:"highcharts-menu"},l.styledMode?{}:{listStyle:"none",margin:0,padding:0},u),l.styledMode||css(m,extend({MozBoxShadow:"3px 3px 10px #0008",WebkitBoxShadow:"3px 3px 10px #0008",boxShadow:"3px 3px 10px #0008"},c?.menuStyle||{})),u.hideMenu=function(){css(u,{display:"none"}),s&&s.setState(0),l.exporting&&(l.exporting.openMenu=!1),css(l.renderTo,{overflow:"hidden"}),css(l.container,{overflow:"hidden"}),clearTimeout(u.hideTimer),fireEvent(l,"exportMenuHidden")},a.events?.push(addEvent(u,"mouseleave",function(){u.hideTimer=win.setTimeout(u.hideMenu,500)}),addEvent(u,"mouseenter",function(){clearTimeout(u.hideTimer)}),addEvent(doc,"mouseup",function(e){l.pointer?.inClass(e.target,t)||u.hideMenu()}),addEvent(u,"click",function(){l.exporting?.openMenu&&u.hideMenu()})),e.forEach(function(t){if("string"==typeof t&&a.options.menuItemDefinitions?.[t]&&(t=a.options.menuItemDefinitions[t]),isObject(t,!0)){let e;t.separator?e=createElement("hr",void 0,void 0,m):("viewData"===t.textKey&&a.isDataTableVisible&&(t.textKey="hideData"),e=createElement("li",{className:"highcharts-menu-item",onclick:function(e){e&&e.stopPropagation(),u.hideMenu(),"string"!=typeof t&&t.onclick&&t.onclick.apply(l,arguments)}},void 0,m),AST.setElementHTML(e,t.text||l.options.lang[t.textKey]),l.styledMode||(e.onmouseover=function(){css(this,c?.menuItemHoverStyle||{})},e.onmouseout=function(){css(this,c?.menuItemStyle||{})},css(e,extend({cursor:"pointer"},c?.menuItemStyle||{})))),a.divElements.push(e)}}),a.divElements.push(m,u),a.menuHeight=u.offsetHeight,a.menuWidth=u.offsetWidth);const f={display:"block"};i+(a.menuWidth||0)>p?f.right=p-i-n-g+"px":f.left=i-g+"px",o+r+(a.menuHeight||0)>d&&"top"!==s.alignOptions?.verticalAlign?f.bottom=d-o-g+"px":f.top=o+r-g+"px",css(u,f),css(l.renderTo,{overflow:""}),css(l.container,{overflow:""}),l.exporting&&(l.exporting.openMenu=!0),fireEvent(l,"exportMenuShown")}destroy(e){const t=this,i=e?e.target:t.chart,{divElements:o,events:n,svgElements:r}=t;let s;r.forEach((e,t)=>{e&&(e.onclick=e.ontouchstart=null,s="cache-"+e.menuClassName,i[s]&&delete i[s],r[t]=e.destroy())}),r.length=0,t.group&&(t.group.destroy(),delete t.group),o.forEach(function(e,t){e&&(clearTimeout(e.hideTimer),removeEvent(e,"mouseleave"),o[t]=e.onmouseout=e.onmouseover=e.ontouchstart=e.onclick=null,discardElement(e))}),o.length=0,n&&(n.forEach(function(e){e()}),n.length=0)}async downloadSVG(t,i){var e={svg:t,exportingOptions:i,exporting:this};if(fireEvent(Exporting.prototype,"downloadSVG",e),!e.defaultPrevented){const{type:s,filename:a,scale:l,libURL:c}=Exporting.prepareImageOptions(i);let e;if("application/pdf"===s)throw new Error("Offline exporting logic for PDF type is not found.");if("image/svg+xml"===s){if(void 0!==win.MSBlobBuilder){const p=new win.MSBlobBuilder;p.append(t),e=p.getBlob("image/svg+xml")}else e=Exporting.svgToDataURL(t);downloadURL(e,a)}else{e=Exporting.svgToDataURL(t);try{Exporting.objectURLRevoke=!0;var o=await Exporting.imageToDataURL(e,l,s);downloadURL(o,a)}catch(e){if("No canvas found!"===e.message)throw e;if(1e8<t.length)throw new Error("Input too long");const d=doc.createElement("canvas"),h=d.getContext("2d"),g=t.match(/^<svg[^>]*\s{,1000}width\s{,1000}=\s{,1000}\"?(\d+)\"?[^>]*>/),m=t.match(/^<svg[^>]*\s{0,1000}height\s{,1000}=\s{,1000}\"?(\d+)\"?[^>]*>/);if(h&&g&&m){var n=+g[1]*l,r=+m[1]*l;d.width=n,d.height=r,win.canvg||(Exporting.objectURLRevoke=!0,await getScript(c+"canvg.js"));{const u=win.canvg.Canvg.fromString(h,t);u.start(),downloadURL(win.navigator.msSaveOrOpenBlob?d.msToBlob():d.toDataURL(s),a)}}}finally{if(Exporting.objectURLRevoke)try{domurl.revokeObjectURL(e)}catch{}}}}}async exportChart(e,t){(e=merge(this.options,e)).local?await this.localExport(e,t||{}):(t=this.getSVGForExport(e,t),e.url&&await HU.post(e.url,{filename:e.filename?e.filename.replace(/\//g,"-"):this.getFilename(),type:e.type,width:e.width,scale:e.scale,svg:t},e.fetchOptions))}async fallbackToServer(e,t){!1===e.fallbackToExportServer?e.error?e.error(e,t):error(28,!0):"application/pdf"===e.type&&(e.local=!1,await this.exportChart(e))}getChartHTML(e){var t=this.chart;return e&&this.inlineStyles(),this.resolveCSSVariables(),t.container.innerHTML}getFilename(){const e=this.chart.userOptions.title?.text;let t=this.options.filename;return t?t.replace(/\//g,"-"):t=!(t="string"==typeof e?e.toLowerCase().replace(/<\/?[^>]+(>|$)/g,"").replace(/[\s_]+/g,"-").replace(/[^a-z\d\-]/g,"").replace(/^[\-]+/g,"").replace(/[\-]+/g,"-").substr(0,24).replace(/[\-]+$/g,""):t)||t.length<5?"chart":t}getSVG(r){const e=this.chart;let t,i,o=merge(e.options,r);o.plotOptions=merge(e.userOptions.plotOptions,r?.plotOptions),o.time=merge(e.userOptions.time,r?.time);var n=createElement("div",void 0,{position:"absolute",top:"-9999em",width:e.chartWidth+"px",height:e.chartHeight+"px"},doc.body),s=e.renderTo.style.width,a=e.renderTo.style.height,s=o.exporting?.sourceWidth||o.chart.width||/px$/.test(s)&&parseInt(s,10)||(o.isGantt?800:600),a=o.exporting?.sourceHeight||o.chart.height||/px$/.test(a)&&parseInt(a,10)||400;extend(o.chart,{animation:!1,renderTo:n,forExport:!0,renderer:"SVGRenderer",width:s,height:a}),o.exporting&&(o.exporting.enabled=!1),delete o.data,o.series=[],e.series.forEach(function(e){(i=merge(e.userOptions,{animation:!1,enableMouseTracking:!1,showCheckbox:!1,visible:e.visible})).isInternal||o?.series?.push(i)});const l={},c=(e.axes.forEach(function(e){e.userOptions.internalKey||(e.userOptions.internalKey=uniqueKey()),o&&!e.options.isInternal&&(l[e.coll]||(l[e.coll]=!0,o[e.coll]=[]),o[e.coll].push(merge(e.userOptions,{visible:e.visible,type:e.type,uniqueNames:e.uniqueNames})))}),o.colorAxis=e.userOptions.colorAxis,new e.constructor(o,e.callback));return r&&["xAxis","yAxis","series"].forEach(function(e){r[e]&&c.update({[e]:r[e]})}),e.axes.forEach(function(t){const e=find(c.axes,e=>e.options.internalKey===t.userOptions.internalKey);var i,o,n;e&&(i=t.getExtremes(),o="min"in(n=splat(r?.[t.coll]||{})[0])?n.min:i.userMin,n="max"in n?n.max:i.userMax,(void 0!==o&&o!==e.min||void 0!==n&&n!==e.max)&&e.setExtremes(o??void 0,n??void 0,!0,!1))}),t=c.exporting?.getChartHTML(e.styledMode||o.exporting?.applyStyleSheets)||"",fireEvent(e,"getSVG",{chartCopy:c}),t=Exporting.sanitizeSVG(t,o),o=void 0,c.destroy(),discardElement(n),t}getSVGForExport(e,t){var i=this.options;return this.getSVG(merge({chart:{borderRadius:0}},i.chartOptions,t,{exporting:{sourceWidth:e?.sourceWidth||i.sourceWidth,sourceHeight:e?.sourceHeight||i.sourceHeight}}))}inlineStyles(){const u=Exporting.inlineDenylist,f=Exporting.inlineAllowlist,x={};let v;const e=createElement("iframe",void 0,{width:"1px",height:"1px",visibility:"hidden"},doc.body),y=e.contentWindow?.document;y&&y.body.appendChild(y.createElementNS(SVG_NS,"svg")),function e(t){const i={};let o,n,r,s,a,l;if(y&&1===t.nodeType&&-1===Exporting.unstyledElements.indexOf(t.nodeName)){if(o=win.getComputedStyle(t,null),n="svg"===t.nodeName?{}:win.getComputedStyle(t.parentNode,null),!x[t.nodeName]){v=y.getElementsByTagName("svg")[0],r=y.createElementNS(t.namespaceURI,t.nodeName),v.appendChild(r);const d=win.getComputedStyle(r,null),h={};for(const g in d)g.length<1e3&&"string"==typeof d[g]&&!/^\d+$/.test(g)&&(h[g]=d[g]);x[t.nodeName]=h,"text"===t.nodeName&&delete x.text.fill,v.removeChild(r)}for(const m in o)if(isFirefox||isMS||isSafari||Object.hasOwnProperty.call(o,m)){p=c=void 0;var c=o[m],p=m;if(s=a=!1,f.length){for(l=f.length;l--&&!a;)a=f[l].test(p);s=!a}for("transform"===p&&"none"===c&&(s=!0),l=u.length;l--&&!s;){if(1e3<p.length)throw new Error("Input too long");s=u[l].test(p)||"function"==typeof c}s||n[p]===c&&"svg"!==t.nodeName||x[t.nodeName][p]===c||(Exporting.inlineToAttributes&&-1===Exporting.inlineToAttributes.indexOf(p)?i[p]=c:c&&t.setAttribute(Exporting.hyphenate(p),c))}css(t,i),"svg"===t.nodeName&&t.setAttribute("stroke-width","1px"),"text"!==t.nodeName&&[].forEach.call(t.children||t.childNodes,e)}}(this.chart.container.querySelector("svg")),v.parentNode.removeChild(v),e.parentNode.removeChild(e)}async localExport(t,e){const i=this.chart;let o,n,r,s;if(isMS&&i.styledMode&&!Exporting.inlineAllowlist.length&&Exporting.inlineAllowlist.push(/^blockSize/,/^border/,/^caretColor/,/^color/,/^columnRule/,/^columnRuleColor/,/^cssFloat/,/^cursor/,/^fill$/,/^fillOpacity/,/^font/,/^inlineSize/,/^length/,/^lineHeight/,/^opacity/,/^outline/,/^parentRule/,/^rx$/,/^ry$/,/^stroke/,/^textAlign/,/^textAnchor/,/^textDecoration/,/^transform/,/^vectorEffect/,/^visibility/,/^x$/,/^y$/),isMS&&("application/pdf"===t.type||i.container.getElementsByTagName("image").length&&"image/svg+xml"!==t.type)||"application/pdf"===t.type&&[].some.call(i.container.getElementsByTagName("image"),function(e){const t=e.getAttribute("href");return""!==t&&"string"==typeof t&&0!==t.indexOf("data:")}))await this.fallbackToServer(t,new Error("Image type not supported for this chart/browser."));else{const c=addEvent(i,"getSVG",e=>{n=e.chartCopy.options,o=e.chartCopy.container.cloneNode(!0),s=o&&o.getElementsByTagName("image")||[]});try{var a;this.getSVGForExport(t,e);for(const d of s?Array.from(s):[])(r=d.getAttributeNS("http://www.w3.org/1999/xlink","href"))?(Exporting.objectURLRevoke=!1,a=await Exporting.imageToDataURL(r,t?.scale||1,t?.type||"image/png"),d.setAttributeNS("http://www.w3.org/1999/xlink","href",a)):d.parentNode.removeChild(d);l=o?.innerHTML;const p=Exporting.sanitizeSVG(l||"",n);if(-1<p.indexOf("<foreignObject")&&"image/svg+xml"!==t.type&&(isMS||"application/pdf"===t.type))throw new Error("Image type not supported for charts with embedded HTML");return await this.downloadSVG(p,extend({filename:this.getFilename()},t)),p}catch(e){await this.fallbackToServer(t,e)}finally{c()}var l}}moveContainers(t){const e=this.chart,i=e["scrollablePlotArea"];(i?[i.fixedDiv,i.scrollingContainer]:[e.container]).forEach(function(e){t.appendChild(e)})}print(){const e=this.chart;this.isPrinting||(Exporting.printingChart=e,isSafari||this.beforePrint(),setTimeout(()=>{win.focus(),win.print(),isSafari||setTimeout(()=>{e.exporting?.afterPrint()},1e3)},1))}render(){const t=this,{chart:e,options:i}=t,o=t?.isDirty||!t?.svgElements.length;t.buttonOffset=0,t.isDirty&&t.destroy(),o&&!1!==i.enabled&&(t.events=[],t.group||(t.group=e.renderer.g("exporting-group").attr({zIndex:3}).add()),objectEach(i?.buttons,function(e){t.addButton(e)}),t.isDirty=!1)}resolveCSSVariables(){Array.from(this.chart.container.querySelectorAll("*")).forEach(o=>{["color","fill","stop-color","stroke"].forEach(e=>{const t=o.getAttribute(e),i=(t?.includes("var(")&&o.setAttribute(e,getComputedStyle(o).getPropertyValue(e)),o.style?.[e]);i?.includes("var(")&&(o.style[e]=getComputedStyle(o).getPropertyValue(e))})})}update(e,t){this.isDirty=!0,merge(!0,this.options,e),pick(t,!0)&&this.chart.redraw()}}Exporting.inlineAllowlist=[],Exporting.inlineDenylist=[/-/,/^(clipPath|cssText|d|height|width)$/,/^font$/,/[lL]ogical(Width|Height)$/,/^parentRule$/,/^(cssRules|ownerRules)$/,/perspective/,/TapHighlightColor/,/^transition/,/^length$/,/^\d+$/],Exporting.inlineToAttributes=["fill","stroke","strokeLinecap","strokeLinejoin","strokeWidth","textAnchor","x","y"],Exporting.loadEventDeferDelay=isMS?150:0,Exporting.unstyledElements=["clipPath","defs","desc"],function(o){function i(e){const t=e.exporting;t&&(t.render(),addEvent(e,"redraw",function(){this.exporting?.render()}),addEvent(e,"destroy",function(){this.exporting?.destroy()}))}function n(){const i=this;i.options.exporting&&(i.exporting=new o(i,i.options.exporting),ChartNavigationComposition.compose(i).navigation.addUpdate((e,t)=>{i.exporting&&(i.exporting.isDirty=!0,merge(!0,i.options.navigation,e),pick(t,!0)&&i.redraw())}))}function r({alignTo:e,key:t,textPxLength:i}){var o=this.options.exporting,{align:n,buttonSpacing:r=0,verticalAlign:s,width:a=0}=merge(this.options.navigation?.buttonOptions,o?.buttons?.contextButton),i=e.width-i,a=a+r;(o?.enabled??!0)&&"title"===t&&"right"===n&&"top"===s&&i<2*a&&(i<a?e.width-=a:"left"!==this.title?.alignValue&&(e.x-=a-i/2))}o.compose=function(e,t){ExportingSymbols.compose(t),Fullscreen.compose(e),pushUnique(composed,"Exporting")&&(extend(Chart.prototype,{exportChart:async function(e,t){await this.exporting?.exportChart(e,t)},getChartHTML:function(e){return this.exporting?.getChartHTML(e)},getFilename:function(){return this.exporting?.getFilename()},getSVG:function(e){return this.exporting?.getSVG(e)},print:function(){return this.exporting?.print()}}),e.prototype.callbacks.push(i),addEvent(e,"afterInit",n),addEvent(e,"layOutTitle",r),isSafari&&win.matchMedia("print").addListener(function(e){o.printingChart&&(e.matches?o.printingChart.exporting?.beforePrint():o.printingChart.exporting?.afterPrint())}),setOptions(ExportingDefaults))}}(Exporting=Exporting||{});export default Exporting;export{domurl};